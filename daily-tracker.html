<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Tracker - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">

    <style>
        /* COMPLETE MOBILE DAILY TRACKER FIX */
/* Add this to your daily-tracker.html in a <style> tag or to styles.css */

/* 1. FORCE CHECKBOXES TO SHOW ON MOBILE - OVERRIDE EXISTING CSS */
@media (max-width: 768px) {
    
    /* CRITICAL: Override the existing mobile rules that hide checkboxes */
    .goal-tracker-item {
        display: flex !important;
        flex-direction: row !important; /* Force horizontal layout */
        align-items: center !important;
        padding: 1.25rem !important;
        margin-bottom: 1rem !important;
        background: var(--surface) !important;
        border-radius: 12px !important;
        border: 2px solid var(--border) !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        text-align: left !important; /* Override any center alignment */
    }
    
    /* CRITICAL: Force checkbox container to stay visible */
    .goal-tracker-item > div:first-child {
        margin-right: 1rem !important;
        flex-shrink: 0 !important;
        align-self: center !important;
        margin-bottom: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        order: 1 !important; /* Ensure it comes first */
    }
    
    /* CRITICAL: Force checkbox to be visible and touchable */
    .goal-tracker-item input[type="checkbox"] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 32px !important;
        height: 32px !important;
        transform: scale(1.5) !important;
        margin: 0 !important;
        cursor: pointer !important;
        pointer-events: auto !important;
        position: relative !important;
        z-index: 10 !important;
    }
    
    /* Content area */
    .goal-tracker-item > div:nth-child(2) {
        flex: 1 !important;
        margin: 0 !important;
        order: 2 !important;
    }
    
    /* Status badge */
    .goal-tracker-item > div:last-child {
        margin-left: 0.75rem !important;
        flex-shrink: 0 !important;
        order: 3 !important;
    }
    
    /* Remove problematic margin overrides */
    .goal-tracker-item > div {
        margin: 0 !important;
    }
}

/* 2. FIX MODAL FALLING OFF SCREEN ON MOBILE */
@media (max-width: 768px) {
    
    /* Fix the goal detail modal container */
    #goalDetailModal {
        display: none;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.5) !important;
        z-index: 9999 !important;
        backdrop-filter: blur(4px) !important;
        padding: 1rem !important;
        box-sizing: border-box !important;
    }
    
    /* Fix the modal content positioning */
    #goalDetailModal > div {
        display: flex !important;
        align-items: flex-start !important; /* Start from top on mobile */
        justify-content: center !important;
        width: 100% !important;
        height: 100% !important;
        padding: 1rem !important;
        box-sizing: border-box !important;
        overflow-y: auto !important; /* Allow scrolling if content is tall */
    }
    
    /* Fix the modal card itself */
    #goalDetailModal > div > div {
        background: white !important;
        border-radius: 16px !important;
        width: 100% !important;
        max-width: 100% !important; /* Prevent overflow */
        max-height: 90vh !important;
        overflow: hidden !important;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25) !important;
        margin: 2rem 0 !important; /* Add top margin for status bar */
        position: relative !important;
        left: auto !important;
        right: auto !important;
        transform: none !important;
    }
    
    /* Fix modal header */
    #goalDetailModal #modalHeader {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 1.5rem !important;
        text-align: center !important;
        border-radius: 16px 16px 0 0 !important;
    }
    
    /* Fix modal body */
    #goalDetailModal > div > div > div:nth-child(2) {
        max-height: 60vh !important;
        overflow-y: auto !important;
        padding: 1.5rem !important;
        box-sizing: border-box !important;
    }
    
    /* Fix modal footer */
    #goalDetailModal > div > div > div:last-child {
        padding: 1rem 1.5rem !important;
        border-top: 1px solid var(--border) !important;
        background: var(--surface) !important;
        display: flex !important;
        gap: 1rem !important;
        justify-content: flex-end !important;
        border-radius: 0 0 16px 16px !important;
    }
    
    /* Fix buttons in modal */
    #goalDetailModal .btn {
        min-height: 44px !important;
        touch-action: manipulation !important;
        font-size: 1rem !important;
        padding: 0.75rem 1.5rem !important;
    }
    
    /* Fix the complete/incomplete buttons */
    #markCompleteBtn,
    #markIncompleteBtn {
        flex: 1 !important;
        max-width: none !important;
        width: auto !important;
    }
}

/* 3. EXTRA SMALL SCREENS (PHONES) */
@media (max-width: 480px) {
    
    /* Even bigger checkboxes for small phones */
    .goal-tracker-item input[type="checkbox"] {
        width: 36px !important;
        height: 36px !important;
        transform: scale(1.3) !important;
    }
    
    /* Adjust modal for very small screens */
    #goalDetailModal {
        padding: 0.5rem !important;
    }
    
    #goalDetailModal > div > div {
        margin: 1rem 0 !important;
        border-radius: 12px !important;
    }
    
    #goalDetailModal #modalHeader {
        padding: 1rem !important;
    }
    
    #goalDetailModal #modalHeader h2 {
        font-size: 1.5rem !important;
    }
}

/* 4. DEBUGGING - TEMPORARY VISUAL AIDS */
.debug-mobile .goal-tracker-item {
    border: 3px solid red !important;
}

.debug-mobile .goal-tracker-item > div:first-child {
    border: 2px solid blue !important;
    background: rgba(0, 0, 255, 0.1) !important;
}

.debug-mobile .goal-tracker-item input[type="checkbox"] {
    border: 2px solid green !important;
    background: rgba(0, 255, 0, 0.2) !important;
}

/* 5. ENSURE TOUCH TARGETS ARE ACCESSIBLE */
@media (max-width: 768px) {
    
    /* Make sure clicks work properly */
    .goal-tracker-item {
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
    }
    
    /* Prevent modal from being cut off */
    body.modal-open {
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
    }
    
    /* Improve checkbox accessibility */
    .goal-tracker-item input[type="checkbox"] {
        -webkit-appearance: none !important;
        appearance: none !important;
        background: white !important;
        border: 3px solid var(--border) !important;
        border-radius: 4px !important;
        position: relative !important;
    }
    
    .goal-tracker-item input[type="checkbox"]:checked {
        background: var(--primary) !important;
        border-color: var(--primary) !important;
    }
    
    .goal-tracker-item input[type="checkbox"]:checked::after {
        content: '✓' !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 1.2rem !important;
    }
}
        </style>
</head>
<body data-page="daily-tracker">
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
                <button class="sidebar-toggle" aria-label="Toggle navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="menu-item">Dashboard</a></li>
                <li><a href="ai-coach.html" class="menu-item">AI Coach</a></li>
                <li><a href="community.html" class="menu-item">Community</a></li>
                <li><a href="goals.html" class="menu-item">Goals</a></li>
                <li><a href="daily-tracker.html" class="menu-item active">Daily Tracker</a></li>
                <li><a href="daily-prompt.html" class="menu-item">Daily Prompt</a></li>
                <li><a href="billing.html" class="menu-item">Billing</a></li>
                <li><a href="settings.html" class="menu-item">Settings</a></li>
                <li><a href="#" class="menu-item" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h1>Daily Tracker</h1>
                <div class="header-actions">
                    <!-- Notification Icon -->
                    <div class="notification-icon-container" onclick="goToNotifications()">
                        <div class="notification-bell">
                           <svg class="bell-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"> 
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/> 
                           </svg>
                            <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="markAllComplete()">
                        Complete All Today
                    </button>
                </div>
            </header>

            <!-- Tracker Hero Section -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 3rem 2rem; text-align: center; margin: -2rem -2rem 3rem -2rem; border-radius: 0 0 16px 16px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800;">Today's Progress</h1>
                <p style="font-size: 1.2rem; opacity: 0.9; max-width: 600px; margin: 0 auto;" id="currentDateDisplay">Loading...</p>
                <div style="margin-top: 2rem; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="completedToday">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Completed Today</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="totalGoals">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Goals</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="longestStreak">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Longest Streak</div>
                    </div>
                </div>
            </div>

            <!-- Daily Goals Tracker -->
            <div style="background: var(--background); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0; color: var(--text-primary);">Today's Goals</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            Progress: <span id="progressPercentage">0%</span>
                        </div>
                        <div style="width: 120px; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="height: 100%; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>

                <div id="dailyGoalsList">
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <p style="margin-bottom: 1rem; font-size: 1.1rem;">Loading your daily goals...</p>
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Weekly/Monthly Progress Chart -->
            <div style="background: var(--background); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin: 0; color: var(--text-primary);">Progress Overview</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="weeklyBtn" onclick="showWeeklyProgress()" class="btn btn-small" style="background: var(--primary); color: white;">
                            Weekly
                        </button>
                        <button id="monthlyBtn" onclick="showMonthlyProgress()" class="btn btn-small" style="background: var(--surface); color: var(--text-primary); border: 2px solid var(--border);">
                            Monthly
                        </button>
                    </div>
                </div>
                <div id="progressChart" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 1rem;">
                    <!-- Progress will be populated by JavaScript -->
                </div>
            </div>

            <!-- Goals by Area Overview -->
            <div style="background: var(--background); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
                <h2 style="margin-bottom: 2rem; color: var(--text-primary);">Goals by Life Area</h2>
                <div id="goalsByArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <!-- Goals by area will be populated by JavaScript -->
                </div>
            </div>

         

    <!-- Goal Detail Modal -->
    <div id="goalDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; backdrop-filter: blur(4px);">
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 2rem;">
            <div style="background: white; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                
                <!-- Modal Header -->
                <div id="modalHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center;">
                    <h2 id="modalTitle" style="margin: 0; font-size: 1.75rem; font-weight: 700;">Goal Details</h2>
                    <p id="modalArea" style="margin: 0.5rem 0 0 0; opacity: 0.9; text-transform: capitalize;"></p>
                </div>
                
                <!-- Modal Body -->
                <div style="max-height: 60vh; overflow-y: auto; padding: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Big Goal</h3>
                        <p id="modalBigGoal" style="color: var(--text-secondary); line-height: 1.5; font-style: italic;"></p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Daily Action</h3>
                        <p id="modalDailyAction" style="color: var(--text-secondary); line-height: 1.5; font-weight: 500;"></p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: var(--surface); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary);" id="modalStreak">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Current Streak</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--surface); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 800; color: var(--success);" id="modalLastCompleted">Never</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Last Completed</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Mark as Complete for Today</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button id="markCompleteBtn" onclick="markGoalComplete()" class="btn btn-primary" style="flex: 1;">
                                Complete Today's Action
                            </button>
                            <button id="markIncompleteBtn" onclick="markGoalIncomplete()" class="btn btn-secondary" style="flex: 1; display: none;">
                                Mark Incomplete
                            </button>
                        </div>
                        <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">
                            Only mark complete if you actually did today's action!
                        </p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border); background: var(--surface); display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeGoalDetail()" style="background: var(--surface); border: 2px solid var(--border); color: var(--text-primary); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="sidebar-toggle.js"></script>
    <script>
// ENHANCED Daily Tracker - Server Only Approach with Fixed Progress Calculation
let currentGoals = [];
let selectedGoal = null;
let progressView = 'weekly';

// API Base URL
const API_BASE_URL = 'https://ai-coach-backend-pbse.onrender.com';

// Area color configuration
const areaColors = {
    mind: '#8b5cf6',
    spirit: '#06b6d4', 
    body: '#10b981',
    work: '#f59e0b',
    relationships: '#ec4899',
    fun: '#f97316',
    finances: '#059669'
};

// FIXED: PST timezone helper functions
function getPSTDate(date = new Date()) {
    // Convert any date to PST midnight for consistent daily boundaries
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    const pstOffset = -8; // PST is UTC-8 (adjust to -7 for PDT if needed)
    const pst = new Date(utc + (pstOffset * 3600000));
    pst.setHours(0, 0, 0, 0); // Set to midnight PST
    return pst;
}

function getTodayPST() {
    return getPSTDate(new Date());
}

function formatDateForComparison(date) {
    // Returns YYYY-MM-DD format in PST for reliable date comparison
    const pstDate = getPSTDate(new Date(date));
    return pstDate.toISOString().split('T')[0];
}


        // FIXED: Goal completion checker - simplified and reliable
function isGoalCompletedToday(goal) {
    const todayString = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
    
    console.log(`🔍 FIXED - Checking completion for goal ${goal._id}:`, {
        goalId: goal._id,
        todayString: todayString,
        lastCompletedDate: goal.lastCompletedDate,
        completed: goal.completed
    });

    // METHOD 1: Check lastCompletedDate (most reliable)
    if (goal.lastCompletedDate) {
        const completedDateString = new Date(goal.lastCompletedDate).toISOString().split('T')[0];
        const isCompletedToday = completedDateString === todayString;
        
        console.log(`📅 FIXED - lastCompletedDate check:`, {
            completedDateString,
            todayString,
            isCompletedToday
        });
        
        if (isCompletedToday) {
            console.log(`✅ FIXED - Goal completed today via lastCompletedDate`);
            return true;
        }
    }

    // METHOD 2: Check completion history if available
    if (goal.completionHistory && Array.isArray(goal.completionHistory) && goal.completionHistory.length > 0) {
        const todayEntry = goal.completionHistory.find(entry => {
            if (!entry.date) return false;
            const entryDateString = new Date(entry.date).toISOString().split('T')[0];
            return entryDateString === todayString;
        });
        
        if (todayEntry) {
            console.log(`✅ FIXED - Found today's entry in completion history:`, todayEntry);
            return todayEntry.completed;
        }
    }

    // METHOD 3: Fallback to basic completed field
    if (goal.hasOwnProperty('completed')) {
        console.log(`🔄 FIXED - Using basic completed field:`, goal.completed);
        return goal.completed;
    }

    console.log(`❌ FIXED - No completion data found for goal ${goal._id} - defaulting to false`);
    return false;
}

// Initialize page
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentDate();
    loadDailyGoals();
    initializeEmotionTracker(); // NEW: Initialize emotion tracker
    updateNotificationCount();
    setInterval(updateNotificationCount, 30000);
    
});

function updateCurrentDate() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        timeZone: 'America/Los_Angeles' // PST/PDT timezone
    };
    document.getElementById('currentDateDisplay').textContent = now.toLocaleDateString('en-US', options);
}

async function loadDailyGoals() {
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) {
            showError('Please log in to view your goals');
            return;
        }

        console.log('🔄 Loading goals from server...');

        const response = await fetch(`${API_BASE_URL}/api/life-goals`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load goals');
        }

        currentGoals = await response.json();
        console.log('✅ Goals loaded:', currentGoals);
        
        renderDailyGoals();
        updateProgressStats();
        showWeeklyProgress();
        renderGoalsByArea();

    } catch (error) {
        console.error('❌ Error loading goals:', error);
        showError('Failed to load your goals. Please try again.');
    }
}

function renderDailyGoals() {
    const container = document.getElementById('dailyGoalsList');
    
    if (currentGoals.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="width: 80px; height: 80px; background: var(--border); border-radius: 50%; margin: 0 auto 2rem auto; display: flex; align-items: center; justify-content: center;">
                    <div style="width: 40px; height: 40px; background: var(--text-muted); border-radius: 50%;"></div>
                </div>
                <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">No Goals Set Yet</h3>
                <p style="margin-bottom: 2rem; line-height: 1.6;">Start by creating your first life goal to begin tracking your daily progress!</p>
                <button onclick="window.location.href='goals.html'" class="btn btn-primary">
                    Create Your First Goal
                </button>
            </div>
        `;
        return;
    }

    let html = '';
    
    currentGoals.forEach(goal => {
        const color = areaColors[goal.area] || '#6366f1';
        const isCompletedToday = isGoalCompletedToday(goal);
        
        html += `
            <div class="goal-tracker-item" data-goal-id="${goal._id}" style="
                display: flex; 
                align-items: center; 
                padding: 1.5rem; 
                margin-bottom: 1rem; 
                background: var(--surface); 
                border-radius: 12px; 
                border: 2px solid ${isCompletedToday ? color : 'var(--border)'}; 
                cursor: pointer;
                transition: all 0.3s ease;
                ${isCompletedToday ? `background: linear-gradient(135deg, ${color}15 0%, ${color}05 100%);` : ''}
            " onclick="openGoalDetail('${goal._id}')">
                
                <!-- Completion Checkbox -->
                <div style="margin-right: 1rem; flex-shrink: 0;">
                    <input type="checkbox" 
                           id="goal-${goal._id}" 
                           ${isCompletedToday ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleGoalCompletion('${goal._id}')"
                           style="
                               width: 24px; 
                               height: 24px; 
                               accent-color: ${color}; 
                               cursor: pointer;
                               transform: scale(1.2);
                           ">
                </div>
                
                <!-- Goal Content -->
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="
                            background: ${color}; 
                            color: white; 
                            padding: 0.25rem 0.75rem; 
                            border-radius: 12px; 
                            font-size: 0.75rem; 
                            font-weight: 600; 
                            text-transform: uppercase;
                        ">${goal.area}</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            Streak: <span style="font-weight: 600; color: ${color};">${goal.streak || 0} days</span>
                        </div>
                    </div>
                    <h3 style="
                        margin: 0 0 0.5rem 0; 
                        color: var(--text-primary); 
                        font-size: 1.1rem; 
                        font-weight: 600;
                        ${isCompletedToday ? 'text-decoration: line-through; opacity: 0.7;' : ''}
                    ">${goal.dailyAction}</h3>
                    <p style="
                        margin: 0; 
                        color: var(--text-secondary); 
                        font-size: 0.9rem; 
                        line-height: 1.4;
                        ${isCompletedToday ? 'opacity: 0.6;' : ''}
                    ">${goal.bigGoal}</p>
                </div>
                
                <!-- Status Badge -->
                <div style="margin-left: 1rem;">
                    ${isCompletedToday ? 
                        `<div style="
                            background: ${color}; 
                            color: white; 
                            padding: 0.5rem 1rem; 
                            border-radius: 20px; 
                            font-size: 0.875rem; 
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        ">
                            Complete
                        </div>` : 
                        `<div style="
                            background: var(--border); 
                            color: var(--text-muted); 
                            padding: 0.5rem 1rem; 
                            border-radius: 20px; 
                            font-size: 0.875rem; 
                            font-weight: 500;
                        ">
                            Pending
                        </div>`
                    }
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ENHANCED: Progress calculation with better debugging
function updateProgressStats() {
    console.log('📊 === CALCULATING PROGRESS STATS ===');
    
    // Log each goal's completion status for debugging
    currentGoals.forEach((goal, index) => {
        const isCompleted = isGoalCompletedToday(goal);
        console.log(`Goal ${index + 1} (${goal.area}): ${isCompleted ? 'COMPLETED' : 'NOT COMPLETED'}`);
    });
    
    const completedToday = currentGoals.filter(goal => isGoalCompletedToday(goal)).length;
    const totalGoals = currentGoals.length;
    const longestStreak = currentGoals.length > 0 ? Math.max(...currentGoals.map(g => g.streak || 0)) : 0;
    const progressPercentage = totalGoals > 0 ? Math.round((completedToday / totalGoals) * 100) : 0;
    
    console.log('📊 Final progress calculation:', {
        completedToday,
        totalGoals,
        progressPercentage,
        longestStreak
    });
    
    // Update the UI
    document.getElementById('completedToday').textContent = completedToday;
    document.getElementById('totalGoals').textContent = totalGoals;
    document.getElementById('longestStreak').textContent = longestStreak;
    document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
    document.getElementById('progressBar').style.width = `${progressPercentage}%`;
    
    console.log('📊 === PROGRESS STATS UPDATED ===');
}

// FIXED: Progress overview calculation that matches the main progress logic
function calculateDayCompletion(date) {
    if (currentGoals.length === 0) return 0;
    
    const targetDatePST = formatDateForComparison(date);
    const todayPST = formatDateForComparison(new Date());
    
    console.log(`📊 Calculating completion for date: ${targetDatePST}`);
    
    let completedOnDate = 0;
    
    currentGoals.forEach((goal, index) => {
        let isCompletedOnThisDate = false;
        
        // FOR TODAY: Use the same exact logic as isGoalCompletedToday()
        if (targetDatePST === todayPST) {
            // Use the exact same logic as isGoalCompletedToday() for consistency
            isCompletedOnThisDate = isGoalCompletedToday(goal);
            console.log(`📊 TODAY - Goal ${index + 1} (${goal.area}): ${isCompletedOnThisDate ? 'COMPLETED' : 'NOT COMPLETED'}`);
        } else {
            // FOR OTHER DAYS: Use historical data
            if (goal.completionHistory && Array.isArray(goal.completionHistory)) {
                const dateEntry = goal.completionHistory.find(entry => {
                    const entryDatePST = formatDateForComparison(entry.date);
                    return entryDatePST === targetDatePST;
                });
                if (dateEntry && dateEntry.completed) {
                    isCompletedOnThisDate = true;
                }
            }
            // Fallback to lastCompletedDate for historical days
            else if (goal.lastCompletedDate) {
                const completedDatePST = formatDateForComparison(goal.lastCompletedDate);
                if (completedDatePST === targetDatePST) {
                    isCompletedOnThisDate = true;
                }
            }
            console.log(`📊 HISTORICAL (${targetDatePST}) - Goal ${index + 1} (${goal.area}): ${isCompletedOnThisDate ? 'COMPLETED' : 'NOT COMPLETED'}`);
        }
        
        if (isCompletedOnThisDate) {
            completedOnDate++;
        }
    });
    
    const percentage = (completedOnDate / currentGoals.length) * 100;
    console.log(`📊 Date ${targetDatePST}: ${completedOnDate}/${currentGoals.length} = ${percentage}%`);
    
    return percentage;
}

// ENHANCED: Weekly progress with better debugging
function renderWeeklyProgress() {
    console.log('📊 === RENDERING WEEKLY PROGRESS ===');
    
    const container = document.getElementById('progressChart');
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const today = new Date();
    
    let html = '';
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - (6 - i));
        
        const isToday = date.toDateString() === today.toDateString();
        const dayName = days[date.getDay()];
        const dayNumber = date.getDate();
        
        const completionRate = calculateDayCompletion(date);
        
        console.log(`📊 Week day ${dayName} ${dayNumber}: ${completionRate}% (isToday: ${isToday})`);
        
        html += `
            <div style="
                text-align: center; 
                padding: 1rem; 
                background: ${isToday ? 'var(--primary)' : 'var(--surface)'}; 
                color: ${isToday ? 'white' : 'var(--text-primary)'}; 
                border-radius: 12px; 
                border: 2px solid ${isToday ? 'var(--primary)' : 'var(--border)'};
                min-width: 80px;
            ">
                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">${dayName}</div>
                <div style="font-size: 1.2rem; font-weight: 800; margin-bottom: 0.5rem;">${dayNumber}</div>
                <div style="
                    width: 40px; 
                    height: 40px; 
                    border-radius: 50%; 
                    background: ${isToday ? 'rgba(255,255,255,0.2)' : 'var(--border)'}; 
                    margin: 0 auto; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 0.8rem; 
                    font-weight: 600;
                    color: ${isToday ? 'white' : 'var(--text-secondary)'};
                ">
                    ${Math.round(completionRate)}%
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
    console.log('📊 === WEEKLY PROGRESS RENDERED ===');
}

// ENHANCED: Monthly progress with same logic
function renderMonthlyProgress() {
    console.log('📊 === RENDERING MONTHLY PROGRESS ===');
    
    const container = document.getElementById('progressChart');
    const today = new Date();
    
    let html = '';
    
    for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - (29 - i));
        
        const isToday = date.toDateString() === today.toDateString();
        const dayNumber = date.getDate();
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });
        
        const completionRate = calculateDayCompletion(date);
        
        html += `
            <div style="
                text-align: center; 
                padding: 0.75rem; 
                background: ${isToday ? 'var(--primary)' : 'var(--surface)'}; 
                color: ${isToday ? 'white' : 'var(--text-primary)'}; 
                border-radius: 8px; 
                border: 1px solid ${isToday ? 'var(--primary)' : 'var(--border)'};
                min-width: 60px;
            ">
                <div style="font-size: 0.7rem; font-weight: 500; margin-bottom: 0.25rem;">${monthName}</div>
                <div style="font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem;">${dayNumber}</div>
                <div style="
                    width: 30px; 
                    height: 30px; 
                    border-radius: 50%; 
                    background: ${isToday ? 'rgba(255,255,255,0.2)' : 'var(--border)'}; 
                    margin: 0 auto; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 0.7rem; 
                    font-weight: 600;
                    color: ${isToday ? 'white' : 'var(--text-secondary)'};
                ">
                    ${Math.round(completionRate)}%
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
    console.log('📊 === MONTHLY PROGRESS RENDERED ===');
}

function showWeeklyProgress() {
    progressView = 'weekly';
    document.getElementById('weeklyBtn').style.background = 'var(--primary)';
    document.getElementById('weeklyBtn').style.color = 'white';
    document.getElementById('monthlyBtn').style.background = 'var(--surface)';
    document.getElementById('monthlyBtn').style.color = 'var(--text-primary)';
    renderWeeklyProgress();
}

function showMonthlyProgress() {
    progressView = 'monthly';
    document.getElementById('monthlyBtn').style.background = 'var(--primary)';
    document.getElementById('monthlyBtn').style.color = 'white';
    document.getElementById('weeklyBtn').style.background = 'var(--surface)';
    document.getElementById('weeklyBtn').style.color = 'var(--text-primary)';
    renderMonthlyProgress();
}

function renderGoalsByArea() {
    const container = document.getElementById('goalsByArea');
    const areas = ['mind', 'spirit', 'body', 'work', 'relationships', 'fun', 'finances'];
    
    let html = '';
    
    areas.forEach(area => {
        const areaGoals = currentGoals.filter(goal => goal.area === area);
        const completedGoals = areaGoals.filter(goal => isGoalCompletedToday(goal)).length;
        const color = areaColors[area];
        
        if (areaGoals.length > 0) {
            html += `
                <div style="
                    padding: 1.5rem; 
                    background: var(--surface); 
                    border-radius: 12px; 
                    border: 1px solid var(--border);
                    border-top: 4px solid ${color};
                ">
                    <h3 style="
                        margin: 0 0 1rem 0; 
                        color: ${color}; 
                        text-transform: capitalize; 
                        font-weight: 600;
                    ">${area}</h3>
                    <div style="
                        display: flex; 
                        justify-content: space-between; 
                        align-items: center; 
                        margin-bottom: 1rem;
                    ">
                        <span style="color: var(--text-secondary);">Progress</span>
                        <span style="font-weight: 600; color: ${color};">
                            ${completedGoals}/${areaGoals.length}
                        </span>
                    </div>
                    <div style="
                        width: 100%; 
                        height: 8px; 
                        background: var(--border); 
                        border-radius: 4px; 
                        overflow: hidden;
                    ">
                        <div style="
                            height: 100%; 
                            background: ${color}; 
                            width: ${areaGoals.length > 0 ? (completedGoals / areaGoals.length) * 100 : 0}%; 
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                </div>
            `;
        }
    });
    
    if (html === '') {
        html = `
            <div style="
                grid-column: 1 / -1; 
                text-align: center; 
                padding: 2rem; 
                color: var(--text-muted);
            ">
                <p>No goals created yet. <a href="goals.html" style="color: var(--primary);">Create your first goal</a> to see progress by area!</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ENHANCED: Server update function that ensures completion data is created
async function updateGoalOnServer(goalId, completed) {
    console.log(`📤 UPDATING SERVER - goalId: ${goalId}, completed: ${completed}`);
    
    const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
    if (!token) {
        throw new Error('No authentication token');
    }

    // ENHANCED: Include more comprehensive data to ensure tracking works
    const requestData = {
        completed: completed,
        // Always include the completion date info
        lastCompletedDate: completed ? new Date().toISOString() : null
    };
    
    console.log('📤 Enhanced request data:', requestData);

    const response = await fetch(`${API_BASE_URL}/api/life-goals/${goalId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    });

    if (!response.ok) {
        const errorText = await response.text();
        console.error('❌ Server error response:', errorText);
        throw new Error(`Server error: ${response.status}`);
    }

    const updatedGoal = await response.json();
    console.log('✅ Server returned updated goal:', updatedGoal);
    
    // ENHANCED: Update the local goal immediately to prevent UI lag
    const goalIndex = currentGoals.findIndex(g => g._id === goalId);
    if (goalIndex !== -1) {
        currentGoals[goalIndex] = updatedGoal;
        console.log('🔄 Updated local goal in currentGoals array');
    }
    
    return updatedGoal;
}

// ENHANCED: Toggle function that forces complete UI refresh
async function toggleGoalCompletion(goalId) {
    console.log('🔄 TOGGLE CALLED - goalId:', goalId);
    
    try {
        const goal = currentGoals.find(g => g._id === goalId);
        if (!goal) {
            console.log('❌ Goal not found:', goalId);
            return;
        }
        
        const currentlyCompleted = isGoalCompletedToday(goal);
        const newState = !currentlyCompleted;
        
        console.log('📋 Goal current state:', currentlyCompleted);
        console.log('🔄 Setting to:', newState);
        
        // Show immediate feedback
        const checkbox = document.getElementById(`goal-${goalId}`);
        if (checkbox) {
            checkbox.checked = newState;
            checkbox.disabled = true;
        }
        
        // Call the server
        await updateGoalOnServer(goalId, newState);
        
        // ENHANCED: Force all UI updates including progress overview
        console.log('🔄 UPDATING ALL UI COMPONENTS...');
        renderDailyGoals();        // Goal cards
        updateProgressStats();     // Top hero numbers
        renderGoalsByArea();       // Area progress
        
        // CRITICAL: Update the progress overview charts
        if (progressView === 'weekly') {
            renderWeeklyProgress();
        } else {
            renderMonthlyProgress();
        }
        
        // Re-enable checkbox
        if (checkbox) {
            checkbox.disabled = false;
        }
        
        // Show success message
        showSuccess(newState ? 'Goal completed! 🎉' : 'Goal marked as incomplete.');
        
    } catch (error) {
        console.error('❌ Toggle failed:', error);
        showError('Failed to update goal. Please try again.');
        
        // Reset checkbox on error
        const checkbox = document.getElementById(`goal-${goalId}`);
        if (checkbox) {
            checkbox.disabled = false;
            checkbox.checked = !checkbox.checked; // Revert the state
        }
    }
}

function openGoalDetail(goalId) {
    const goal = currentGoals.find(g => g._id === goalId);
    if (!goal) return;
    
    selectedGoal = goal;
    const color = areaColors[goal.area] || '#6366f1';
    
    document.getElementById('modalTitle').textContent = 'Goal Details';
    document.getElementById('modalArea').textContent = goal.area;
    document.getElementById('modalBigGoal').textContent = goal.bigGoal;
    document.getElementById('modalDailyAction').textContent = goal.dailyAction;
    document.getElementById('modalStreak').textContent = goal.streak || 0;
    
    let lastCompletedText = 'Never';
    if (goal.lastCompletedDate) {
        const lastDate = new Date(goal.lastCompletedDate);
        const today = new Date();
        const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            lastCompletedText = 'Today';
        } else if (diffDays === 1) {
            lastCompletedText = 'Yesterday';
        } else {
            lastCompletedText = `${diffDays} days ago`;
        }
    }
    document.getElementById('modalLastCompleted').textContent = lastCompletedText;
    
    document.getElementById('modalHeader').style.background = `linear-gradient(135deg, ${color} 0%, ${adjustBrightness(color, -20)} 100%)`;
    
    updateModalButtons();
    
    document.getElementById('goalDetailModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function updateModalButtons() {
    if (!selectedGoal) return;
    
    const isCompleted = isGoalCompletedToday(selectedGoal);
    const completeBtn = document.getElementById('markCompleteBtn');
    const incompleteBtn = document.getElementById('markIncompleteBtn');
    
    console.log('🔘 Updating modal buttons - goal completed today:', isCompleted);
    
    if (isCompleted) {
        completeBtn.style.display = 'none';
        incompleteBtn.style.display = 'block';
        incompleteBtn.textContent = 'Mark Incomplete';
    } else {
        completeBtn.style.display = 'block';
        incompleteBtn.style.display = 'none';
        completeBtn.textContent = 'Complete Today\'s Action';
    }
}

function closeGoalDetail() {
    document.getElementById('goalDetailModal').style.display = 'none';
    document.body.style.overflow = '';
    selectedGoal = null;
}

async function markGoalComplete() {
    if (!selectedGoal) return;
    console.log('✅ MODAL: Mark Complete clicked');
    await toggleGoalCompletion(selectedGoal._id);
    closeGoalDetail();
}

async function markGoalIncomplete() {
    if (!selectedGoal) return;
    console.log('❌ MODAL: Mark Incomplete clicked');
    await toggleGoalCompletion(selectedGoal._id);
    closeGoalDetail();
}

// ENHANCED: Mark all complete with forced refresh
async function markAllComplete() {
    try {
        const incompleteGoals = currentGoals.filter(goal => !isGoalCompletedToday(goal));
        
        if (incompleteGoals.length === 0) {
            showSuccess('All goals are already complete for today!');
            return;
        }
        
        if (!confirm(`Mark all ${incompleteGoals.length} remaining goals as complete for today?`)) {
            return;
        }
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Completing...';
        button.disabled = true;
        
        for (const goal of incompleteGoals) {
            await updateGoalOnServer(goal._id, true);
        }
        
        // FORCE COMPLETE UI REFRESH
        console.log('🔄 MARK ALL COMPLETE - FORCING UI REFRESH...');
        renderDailyGoals();
        updateProgressStats();
        renderGoalsByArea();
        
        if (progressView === 'weekly') {
            renderWeeklyProgress();
        } else {
            renderMonthlyProgress();
        }
        
        button.textContent = originalText;
        button.disabled = false;
        
        showSuccess('All goals marked as complete! Amazing work today!');
        
    } catch (error) {
        console.error('Error marking all complete:', error);
        showError('Failed to complete all goals. Please try again.');
        
        const button = event.target;
        button.textContent = 'Complete All Today';
        button.disabled = false;
    }
}

function adjustBrightness(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

function showSuccess(message) {
    showToast(message, 'success');
}

function showError(message) {
    showToast(message, 'error');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'var(--success)' : 'var(--error)';
    
    toast.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: ${bgColor};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 4000);
}

function goToNotifications() {
    window.location.href = 'notifications.html';
}

function logout() {
    localStorage.clear();
    window.location.href = 'index.html';
}

async function updateNotificationCount() {
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) return;
        
        const response = await fetch(`${API_BASE_URL}/api/notifications/unread-count`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const count = data.count || 0;
            const countElement = document.getElementById('headerNotificationCount');
            
            if (countElement) {
                countElement.textContent = count;
                countElement.setAttribute('data-count', count);
                countElement.style.display = count > 0 ? 'flex' : 'none';
            }
        }
    } catch (error) {
        console.error('Error fetching notification count:', error);
    }
}

// Event listeners for keyboard shortcuts and modal clicks
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('goalDetailModal').style.display === 'block') {
        closeGoalDetail();
    }
    
    if (e.key === ' ' && selectedGoal && document.getElementById('goalDetailModal').style.display === 'block') {
        e.preventDefault();
        const isCompleted = isGoalCompletedToday(selectedGoal);
        if (isCompleted) {
            markGoalIncomplete();
        } else {
            markGoalComplete();
        }
    }
});

document.getElementById('goalDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeGoalDetail();
    }
});

// ==========================================
// EMOTION TRACKER FUNCTIONALITY - NEW
// ==========================================

// Emotion tracking configuration
const emotionConfig = {
    happy: { emoji: '😊', color: '#10b981', label: 'Happy' },
    excited: { emoji: '🤩', color: '#f59e0b', label: 'Excited' },
    content: { emoji: '😌', color: '#06b6d4', label: 'Content' },
    hopeful: { emoji: '🌟', color: '#8b5cf6', label: 'Hopeful' },
    sad: { emoji: '😢', color: '#6366f1', label: 'Sad' },
    angry: { emoji: '😠', color: '#ef4444', label: 'Angry' },
    disappointed: { emoji: '😞', color: '#f97316', label: 'Disappointed' },
    lonely: { emoji: '😔', color: '#64748b', label: 'Lonely' },
    scared: { emoji: '😨', color: '#dc2626', label: 'Scared' },
    stressed: { emoji: '😰', color: '#7c2d12', label: 'Stressed' }
};

let currentEmotions = [];

// Initialize emotion tracker
function initializeEmotionTracker() {
    console.log('🎭 Initializing emotion tracker...');
    loadTodaysEmotion();
    loadWeeklyEmotions();
}

// Select an emotion for today - SAVE TO BACKEND
async function selectEmotion(emotion) {
    console.log('🎭 Emotion selected:', emotion);
    
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) {
            showError('Please log in to record emotions');
            return;
        }

        // Show loading state
        const button = document.querySelector(`[data-emotion="${emotion}"]`);
        if (button) {
            button.style.opacity = '0.7';
            button.style.pointerEvents = 'none';
        }

        // Save to backend
        const response = await fetch(`${API_BASE_URL}/api/emotions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                emotion: emotion,
                intensity: 3 // Default intensity
            })
        });

        if (!response.ok) {
            throw new Error('Failed to record emotion');
        }

        const emotionEntry = await response.json();
        console.log('✅ Emotion saved to backend:', emotionEntry);
        
        // Update the UI immediately
        updateEmotionSelection(emotion);
        await loadWeeklyEmotions(); // Refresh weekly chart
        
        // Show success message
        showSuccess(`Emotion recorded: ${emotionConfig[emotion].label} ${emotionConfig[emotion].emoji}`);
        
    } catch (error) {
        console.error('❌ Error recording emotion:', error);
        showError('Failed to record emotion. Please try again.');
    } finally {
        // Reset button state
        const button = document.querySelector(`[data-emotion="${emotion}"]`);
        if (button) {
            button.style.opacity = '1';
            button.style.pointerEvents = 'auto';
        }
    }
}

// Update the emotion selection UI
function updateEmotionSelection(selectedEmotion) {
    // Reset all emotion buttons
    document.querySelectorAll('.emotion-btn').forEach(btn => {
        btn.style.border = '2px solid var(--border)';
        btn.style.background = 'var(--surface)';
        btn.style.transform = 'scale(1)';
    });
    
    // Highlight selected emotion
    const selectedBtn = document.querySelector(`[data-emotion="${selectedEmotion}"]`);
    if (selectedBtn) {
        const config = emotionConfig[selectedEmotion];
        selectedBtn.style.border = `2px solid ${config.color}`;
        selectedBtn.style.background = `${config.color}15`;
        selectedBtn.style.transform = 'scale(1.05)';
    }
    
    // Show selected emotion display
    const display = document.getElementById('selectedEmotionDisplay');
    const text = document.getElementById('selectedEmotionText');
    
    if (display && text) {
        const config = emotionConfig[selectedEmotion];
        text.textContent = `${config.label} ${config.emoji}`;
        display.style.display = 'block';
        display.style.background = `linear-gradient(135deg, ${config.color} 0%, ${adjustBrightness(config.color, -20)} 100%)`;
    }
}

// Load today's emotion from backend
async function loadTodaysEmotion() {
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) {
            console.log('🎭 No auth token - skipping emotion load');
            return;
        }

        const response = await fetch(`${API_BASE_URL}/api/emotions/today`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const todaysEmotion = await response.json();
            
            if (todaysEmotion && todaysEmotion.emotion) {
                console.log('🎭 Found today\'s emotion:', todaysEmotion.emotion);
                updateEmotionSelection(todaysEmotion.emotion);
            } else {
                console.log('🎭 No emotion recorded for today yet');
                // Hide the selected emotion display
                const display = document.getElementById('selectedEmotionDisplay');
                if (display) {
                    display.style.display = 'none';
                }
            }
        }
    } catch (error) {
        console.error('❌ Error loading today\'s emotion:', error);
    }
}

// Load weekly emotions from backend
async function loadWeeklyEmotions() {
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) {
            console.log('🎭 No auth token - skipping weekly emotions load');
            renderWeeklyEmotionChart([]);
            return;
        }

        const response = await fetch(`${API_BASE_URL}/api/emotions?days=7`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            currentEmotions = await response.json();
            console.log('🎭 Loaded weekly emotions:', currentEmotions.length, 'entries');
            renderWeeklyEmotionChart(currentEmotions);
        } else {
            console.log('🎭 Failed to load weekly emotions');
            renderWeeklyEmotionChart([]);
        }
    } catch (error) {
        console.error('❌ Error loading weekly emotions:', error);
        renderWeeklyEmotionChart([]);
    }
}

// Render weekly emotion chart
function renderWeeklyEmotionChart(emotions) {
    const container = document.getElementById('weeklyEmotionChart');
    if (!container) return;
    
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const today = new Date();
    
    let html = '';
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - (6 - i));
        date.setHours(0, 0, 0, 0); // Normalize to midnight
        
        const isToday = date.toDateString() === today.toDateString();
        const dayName = days[date.getDay()];
        const dayNumber = date.getDate();
        
        // Find emotion for this day
        let dayEmotion = null;
        let emotionEmoji = '—';
        let emotionColor = 'var(--border)';
        
        const emotionEntry = emotions.find(entry => {
            const entryDate = new Date(entry.date);
            entryDate.setHours(0, 0, 0, 0);
            return entryDate.getTime() === date.getTime();
        });
        
        if (emotionEntry && emotionConfig[emotionEntry.emotion]) {
            dayEmotion = emotionEntry.emotion;
            emotionEmoji = emotionConfig[dayEmotion].emoji;
            emotionColor = emotionConfig[dayEmotion].color;
        }
        
        html += `
            <div style="
                text-align: center; 
                padding: 1rem 0.5rem; 
                background: ${isToday ? 'var(--primary)' : 'var(--surface)'}; 
                color: ${isToday ? 'white' : 'var(--text-primary)'}; 
                border-radius: 12px; 
                border: 2px solid ${isToday ? 'var(--primary)' : (dayEmotion ? emotionColor : 'var(--border)')};
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                ${dayEmotion && !isToday ? `background: ${emotionColor}15;` : ''}
            ">
                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem;">${dayName}</div>
                <div style="font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem;">${dayNumber}</div>
                <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">${emotionEmoji}</div>
                <div style="
                    font-size: 0.65rem; 
                    opacity: 0.8;
                    ${isToday ? 'color: rgba(255,255,255,0.8);' : 'color: var(--text-muted);'}
                ">
                    ${dayEmotion ? emotionConfig[dayEmotion].label : 'No data'}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Get emotion statistics for dashboard integration
async function getEmotionStats() {
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) return null;

        const response = await fetch(`${API_BASE_URL}/api/emotions/stats?days=30`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const stats = await response.json();
            return stats;
        }
    } catch (error) {
        console.error('Error getting emotion stats:', error);
    }
    
    return null;
}

        
// DEBUGGING: Add this function to test UI updates manually
function debugUIRefresh() {
    console.log('🐛 MANUAL UI REFRESH TEST');
    console.log('Current goals:', currentGoals);
    
    // Test each goal's completion status
    currentGoals.forEach((goal, index) => {
        const isCompleted = isGoalCompletedToday(goal);
        console.log(`🐛 Goal ${index + 1}: ${goal.area} - Completed: ${isCompleted}`);
    });
    
    // Force refresh everything
    renderDailyGoals();
    updateProgressStats();
    renderGoalsByArea();
    renderWeeklyProgress();
    
    console.log('🐛 UI refresh complete');
}

// ENHANCED: Add this to the window for debugging
window.debugUIRefresh = debugUIRefresh;

        // ENHANCED: Add this to the window for debugging
window.debugUIRefresh = debugUIRefresh;

// Export emotion tracker functions for global access
window.selectEmotion = selectEmotion;
window.getEmotionStats = getEmotionStats;
window.initializeEmotionTracker = initializeEmotionTracker;
        
// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(100px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideOutRight {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100px); }
    }
    
    .goal-tracker-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    /* NEW: Mood tracker styles */
    .mood-btn:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

       .mood-btn:active {
        transform: scale(0.98) !important;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .goal-tracker-item {
            flex-direction: column !important;
            align-items: stretch !important;
            text-align: left !important;
            padding: 1.25rem !important;
        }
        
        .goal-tracker-item > div {
            margin: 0.5rem 0 !important;
        }
        
        .goal-tracker-item > div:first-child {
            align-self: flex-start !important;
            margin-bottom: 1rem !important;
        }
        
        #progressChart {
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)) !important;
            gap: 0.75rem !important;
        }
        
        #goalsByArea {
            grid-template-columns: 1fr !important;
        }


        #moodButtons {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
            gap: 0.75rem !important;
        }
        
        .content-header {
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 1rem !important;
        }
        
        .content-header h1 {
            text-align: center !important;
            font-size: 1.75rem !important;
        }
        
        .header-actions {
            justify-content: center !important;
        }
    }
    
    @media (max-width: 480px) {
        #progressChart {
            grid-template-columns: repeat(auto-fit, minmax(55px, 1fr)) !important;
            gap: 0.5rem !important;
        }
        
        #progressChart > div {
            padding: 0.5rem 0.25rem !important;
            min-width: 50px !important;
        }

         #moodButtons {
            grid-template-columns: repeat(2, 1fr) !important;
        }
        
        .goal-tracker-item {
            padding: 1rem !important;
        }
    }
`;
document.head.appendChild(style);

        // MOBILE MODAL JAVASCRIPT FIX
// Add this to your daily-tracker.html JavaScript section

// Enhanced openGoalDetail function for mobile
function openGoalDetailMobile(goalId) {
    const goal = currentGoals.find(g => g._id === goalId);
    if (!goal) return;
    
    selectedGoal = goal;
    const color = areaColors[goal.area] || '#6366f1';
    
    // Update modal content
    document.getElementById('modalTitle').textContent = 'Goal Details';
    document.getElementById('modalArea').textContent = goal.area;
    document.getElementById('modalBigGoal').textContent = goal.bigGoal;
    document.getElementById('modalDailyAction').textContent = goal.dailyAction;
    document.getElementById('modalStreak').textContent = goal.streak || 0;
    
    let lastCompletedText = 'Never';
    if (goal.lastCompletedDate) {
        const lastDate = new Date(goal.lastCompletedDate);
        const today = new Date();
        const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            lastCompletedText = 'Today';
        } else if (diffDays === 1) {
            lastCompletedText = 'Yesterday';
        } else {
            lastCompletedText = `${diffDays} days ago`;
        }
    }
    document.getElementById('modalLastCompleted').textContent = lastCompletedText;
    
    document.getElementById('modalHeader').style.background = `linear-gradient(135deg, ${color} 0%, ${adjustBrightness(color, -20)} 100%)`;
    
    updateModalButtons();
    
    // MOBILE FIX: Ensure modal displays correctly
    const modal = document.getElementById('goalDetailModal');
    if (modal) {
        // Prevent body scroll on mobile
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.classList.add('modal-open');
        
        // Show modal
        modal.style.display = 'block';
        
        // Force proper positioning on mobile
        if (window.innerWidth <= 768) {
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '9999';
            
            // Ensure modal content is properly centered
            const modalContent = modal.querySelector('div');
            if (modalContent) {
                modalContent.style.display = 'flex';
                modalContent.style.alignItems = 'flex-start';
                modalContent.style.justifyContent = 'center';
                modalContent.style.padding = '1rem';
                modalContent.style.boxSizing = 'border-box';
                modalContent.style.overflowY = 'auto';
                modalContent.style.width = '100%';
                modalContent.style.height = '100%';
            }
        }
    }
}

// Enhanced closeGoalDetail function for mobile
function closeGoalDetailMobile() {
    const modal = document.getElementById('goalDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // MOBILE FIX: Restore body scroll
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
    document.body.classList.remove('modal-open');
    
    selectedGoal = null;
}

// Enhanced renderDailyGoals function with forced checkboxes
function renderDailyGoalsMobile() {
    const container = document.getElementById('dailyGoalsList');
    
    if (currentGoals.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="width: 80px; height: 80px; background: var(--border); border-radius: 50%; margin: 0 auto 2rem auto; display: flex; align-items: center; justify-content: center;">
                    <div style="width: 40px; height: 40px; background: var(--text-muted); border-radius: 50%;"></div>
                </div>
                <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">No Goals Set Yet</h3>
                <p style="margin-bottom: 2rem; line-height: 1.6;">Start by creating your first life goal to begin tracking your daily progress!</p>
                <button onclick="window.location.href='goals.html'" class="btn btn-primary">
                    Create Your First Goal
                </button>
            </div>
        `;
        return;
    }

    let html = '';
    
    currentGoals.forEach(goal => {
        const color = areaColors[goal.area] || '#6366f1';
        const isCompletedToday = isGoalCompletedToday(goal);
        
        html += `
            <div class="goal-tracker-item" data-goal-id="${goal._id}" style="
                display: flex !important; 
                flex-direction: row !important;
                align-items: center !important; 
                padding: 1.25rem !important; 
                margin-bottom: 1rem !important; 
                background: var(--surface) !important; 
                border-radius: 12px !important; 
                border: 2px solid ${isCompletedToday ? color : 'var(--border)'} !important; 
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                ${isCompletedToday ? `background: linear-gradient(135deg, ${color}15 0%, ${color}05 100%) !important;` : ''}
            " onclick="openGoalDetailMobile('${goal._id}')">
                
                <!-- FORCED CHECKBOX CONTAINER -->
                <div style="
                    margin-right: 1rem !important;
                    flex-shrink: 0 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    order: 1 !important;
                ">
                    <input type="checkbox" 
                           id="goal-${goal._id}" 
                           ${isCompletedToday ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleGoalCompletion('${goal._id}')"
                           style="
                               display: block !important;
                               visibility: visible !important;
                               opacity: 1 !important;
                               width: 32px !important; 
                               height: 32px !important; 
                               accent-color: ${color} !important; 
                               cursor: pointer !important;
                               transform: scale(1.5) !important;
                               margin: 0 !important;
                               position: relative !important;
                               z-index: 10 !important;
                               pointer-events: auto !important;
                           ">
                </div>
                
                <!-- GOAL CONTENT -->
                <div style="flex: 1 !important; margin: 0 !important; order: 2 !important;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                        <div style="
                            background: ${color}; 
                            color: white; 
                            padding: 0.25rem 0.75rem; 
                            border-radius: 12px; 
                            font-size: 0.75rem; 
                            font-weight: 600; 
                            text-transform: uppercase;
                        ">${goal.area}</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            Streak: <span style="font-weight: 600; color: ${color};">${goal.streak || 0} days</span>
                        </div>
                    </div>
                    <h3 style="
                        margin: 0 0 0.5rem 0; 
                        color: var(--text-primary); 
                        font-size: 1.1rem; 
                        font-weight: 600;
                        ${isCompletedToday ? 'text-decoration: line-through; opacity: 0.7;' : ''}
                    ">${goal.dailyAction}</h3>
                    <p style="
                        margin: 0; 
                        color: var(--text-secondary); 
                        font-size: 0.9rem; 
                        line-height: 1.4;
                        ${isCompletedToday ? 'opacity: 0.6;' : ''}
                    ">${goal.bigGoal}</p>
                </div>
                
                <!-- STATUS BADGE -->
                <div style="margin-left: 0.75rem !important; flex-shrink: 0 !important; order: 3 !important;">
                    ${isCompletedToday ? 
                        `<div style="
                            background: ${color}; 
                            color: white; 
                            padding: 0.5rem 1rem; 
                            border-radius: 20px; 
                            font-size: 0.875rem; 
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        ">
                            Complete
                        </div>` : 
                        `<div style="
                            background: var(--border); 
                            color: var(--text-muted); 
                            padding: 0.5rem 1rem; 
                            border-radius: 20px; 
                            font-size: 0.875rem; 
                            font-weight: 500;
                        ">
                            Pending
                        </div>`
                    }
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Replace the original functions with mobile-optimized versions
if (window.innerWidth <= 768) {
    window.openGoalDetail = openGoalDetailMobile;
    window.closeGoalDetail = closeGoalDetailMobile;
    window.renderDailyGoals = renderDailyGoalsMobile;
    
    console.log('✅ Mobile-optimized functions loaded');
}

// Add mobile-specific event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking outside on mobile
    const modal = document.getElementById('goalDetailModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeGoalDetailMobile();
            }
        });
    }
    
    // Prevent body scroll when modal is open
    document.addEventListener('touchmove', function(e) {
        if (document.body.classList.contains('modal-open')) {
            e.preventDefault();
        }
    }, { passive: false });
});

console.log('📱 Mobile fixes loaded!');
    </script>
        
</body>
</html>
