<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Tracker - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
                <button class="sidebar-toggle" aria-label="Toggle navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="menu-item">Dashboard</a></li>
                <li><a href="ai-coach.html" class="menu-item">AI Coach</a></li>
                <li><a href="community.html" class="menu-item">Community</a></li>
                <li><a href="goals.html" class="menu-item">Goals</a></li>
                <li><a href="daily-tracker.html" class="menu-item active">Daily Tracker</a></li>
                <li><a href="billing.html" class="menu-item">Billing</a></li>
                <li><a href="#" class="menu-item" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h1>Daily Tracker</h1>
                <div class="header-actions">
                    <!-- Notification Icon -->
                    <div class="notification-icon-container" onclick="goToNotifications()">
                        <div class="notification-bell">
                           <svg class="bell-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"> 
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/> 
                           </svg>
                            <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="markAllComplete()">
                        Complete All Today
                    </button>
                </div>
            </header>

            <!-- Tracker Hero Section -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 3rem 2rem; text-align: center; margin: -2rem -2rem 3rem -2rem; border-radius: 0 0 16px 16px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800;">Today's Progress</h1>
                <p style="font-size: 1.2rem; opacity: 0.9; max-width: 600px; margin: 0 auto;" id="currentDateDisplay">Loading...</p>
                <div style="margin-top: 2rem; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="completedToday">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Completed Today</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="totalGoals">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Goals</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="longestStreak">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Longest Streak</div>
                    </div>
                </div>
            </div>

            <!-- Daily Goals Tracker -->
            <div style="background: var(--background); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0; color: var(--text-primary);">Today's Goals</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            Progress: <span id="progressPercentage">0%</span>
                        </div>
                        <div style="width: 120px; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="height: 100%; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>

                <div id="dailyGoalsList">
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <p style="margin-bottom: 1rem; font-size: 1.1rem;">Loading your daily goals...</p>
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Weekly/Monthly Progress Chart -->
            <div style="background: var(--background); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin: 0; color: var(--text-primary);">Progress Overview</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="weeklyBtn" onclick="showWeeklyProgress()" class="btn btn-small" style="background: var(--primary); color: white;">
                            Weekly
                        </button>
                        <button id="monthlyBtn" onclick="showMonthlyProgress()" class="btn btn-small" style="background: var(--surface); color: var(--text-primary); border: 2px solid var(--border);">
                            Monthly
                        </button>
                    </div>
                </div>
                <div id="progressChart" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 1rem;">
                    <!-- Progress will be populated by JavaScript -->
                </div>
            </div>

            <!-- Goals by Area Overview -->
            <div style="background: var(--background); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
                <h2 style="margin-bottom: 2rem; color: var(--text-primary);">Goals by Life Area</h2>
                <div id="goalsByArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <!-- Goals by area will be populated by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Goal Detail Modal -->
    <div id="goalDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; backdrop-filter: blur(4px);">
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 2rem;">
            <div style="background: white; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                
                <!-- Modal Header -->
                <div id="modalHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center;">
                    <h2 id="modalTitle" style="margin: 0; font-size: 1.75rem; font-weight: 700;">Goal Details</h2>
                    <p id="modalArea" style="margin: 0.5rem 0 0 0; opacity: 0.9; text-transform: capitalize;"></p>
                </div>
                
                <!-- Modal Body -->
                <div style="max-height: 60vh; overflow-y: auto; padding: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Big Goal</h3>
                        <p id="modalBigGoal" style="color: var(--text-secondary); line-height: 1.5; font-style: italic;"></p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Daily Action</h3>
                        <p id="modalDailyAction" style="color: var(--text-secondary); line-height: 1.5; font-weight: 500;"></p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: var(--surface); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary);" id="modalStreak">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Current Streak</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--surface); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 800; color: var(--success);" id="modalLastCompleted">Never</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Last Completed</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Mark as Complete for Today</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button id="markCompleteBtn" onclick="markGoalComplete()" class="btn btn-primary" style="flex: 1;">
                                Complete Today's Action
                            </button>
                            <button id="markIncompleteBtn" onclick="markGoalIncomplete()" class="btn btn-secondary" style="flex: 1; display: none;">
                                Mark Incomplete
                            </button>
                        </div>
                        <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">
                            Only mark complete if you actually did today's action!
                        </p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border); background: var(--surface); display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeGoalDetail()" style="background: var(--surface); border: 2px solid var(--border); color: var(--text-primary); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="sidebar-toggle.js"></script>
    <script>
        // Daily Tracker JavaScript Implementation
        let currentGoals = [];
        let selectedGoal = null;
        let progressView = 'weekly';
        
        // API Base URL
        const API_BASE_URL = 'https://ai-coach-backend-pbse.onrender.com';
        
        // Area color configuration
        const areaColors = {
            mind: '#8b5cf6',
            spirit: '#06b6d4', 
            body: '#10b981',
            work: '#f59e0b',
            relationships: '#ec4899',
            fun: '#f97316',
            finances: '#059669'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            loadDailyGoals();
            updateNotificationCount();
            setInterval(updateNotificationCount, 30000);
        });

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDateDisplay').textContent = now.toLocaleDateString('en-US', options);
        }

        async function loadDailyGoals() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) {
                    showError('Please log in to view your goals');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/life-goals`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load goals');
                }

                currentGoals = await response.json();
                renderDailyGoals();
                updateProgressStats();
                showWeeklyProgress();
                renderGoalsByArea();

            } catch (error) {
                console.error('Error loading goals:', error);
                showError('Failed to load your goals. Please try again.');
            }
        }

        function renderDailyGoals() {
            const container = document.getElementById('dailyGoalsList');
            
            if (currentGoals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="width: 80px; height: 80px; background: var(--border); border-radius: 50%; margin: 0 auto 2rem auto; display: flex; align-items: center; justify-content: center;">
                            <div style="width: 40px; height: 40px; background: var(--text-muted); border-radius: 50%;"></div>
                        </div>
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">No Goals Set Yet</h3>
                        <p style="margin-bottom: 2rem; line-height: 1.6;">Start by creating your first life goal to begin tracking your daily progress!</p>
                        <button onclick="window.location.href='goals.html'" class="btn btn-primary">
                            Create Your First Goal
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            
            currentGoals.forEach(goal => {
                const color = areaColors[goal.area] || '#6366f1';
                const isCompletedToday = isGoalCompletedToday(goal);
                
                html += `
                    <div class="goal-tracker-item" data-goal-id="${goal._id}" style="
                        display: flex; 
                        align-items: center; 
                        padding: 1.5rem; 
                        margin-bottom: 1rem; 
                        background: var(--surface); 
                        border-radius: 12px; 
                        border: 2px solid ${isCompletedToday ? color : 'var(--border)'}; 
                        cursor: pointer;
                        transition: all 0.3s ease;
                        ${isCompletedToday ? `background: linear-gradient(135deg, ${color}15 0%, ${color}05 100%);` : ''}
                    " onclick="openGoalDetail('${goal._id}')">
                        
                        <!-- Completion Checkbox -->
                        <div style="margin-right: 1rem; flex-shrink: 0;">
                            <input type="checkbox" 
                                   id="goal-${goal._id}" 
                                   ${isCompletedToday ? 'checked' : ''} 
                                   onclick="event.stopPropagation(); toggleGoalCompletion('${goal._id}')"
                                   style="
                                       width: 24px; 
                                       height: 24px; 
                                       accent-color: ${color}; 
                                       cursor: pointer;
                                       transform: scale(1.2);
                                   ">
                        </div>
                        
                        <!-- Goal Content -->
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="
                                    background: ${color}; 
                                    color: white; 
                                    padding: 0.25rem 0.75rem; 
                                    border-radius: 12px; 
                                    font-size: 0.75rem; 
                                    font-weight: 600; 
                                    text-transform: uppercase;
                                ">${goal.area}</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">
                                    Streak: <span style="font-weight: 600; color: ${color};">${goal.streak || 0} days</span>
                                </div>
                            </div>
                            <h3 style="
                                margin: 0 0 0.5rem 0; 
                                color: var(--text-primary); 
                                font-size: 1.1rem; 
                                font-weight: 600;
                                ${isCompletedToday ? 'text-decoration: line-through; opacity: 0.7;' : ''}
                            ">${goal.dailyAction}</h3>
                            <p style="
                                margin: 0; 
                                color: var(--text-secondary); 
                                font-size: 0.9rem; 
                                line-height: 1.4;
                                ${isCompletedToday ? 'opacity: 0.6;' : ''}
                            ">${goal.bigGoal}</p>
                        </div>
                        
                        <!-- Status Badge -->
                        <div style="margin-left: 1rem;">
                            ${isCompletedToday ? 
                                `<div style="
                                    background: ${color}; 
                                    color: white; 
                                    padding: 0.5rem 1rem; 
                                    border-radius: 20px; 
                                    font-size: 0.875rem; 
                                    font-weight: 600;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                ">
                                    Complete
                                </div>` : 
                                `<div style="
                                    background: var(--border); 
                                    color: var(--text-muted); 
                                    padding: 0.5rem 1rem; 
                                    border-radius: 20px; 
                                    font-size: 0.875rem; 
                                    font-weight: 500;
                                ">
                                    Pending
                                </div>`
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

function isGoalCompletedToday(goal) {
    console.log('🗓️ Checking completion for goal:', goal._id);
    console.log('📅 Goal lastCompletedDate:', goal.lastCompletedDate);
    console.log('📅 Goal completed field:', goal.completed);
    
    if (!goal.lastCompletedDate) {
        console.log('❌ No lastCompletedDate, returning false');
        return false;
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const lastCompleted = new Date(goal.lastCompletedDate);
    lastCompleted.setHours(0, 0, 0, 0);
    
    const isToday = today.getTime() === lastCompleted.getTime();
    console.log('🗓️ Today:', today.toISOString().split('T')[0]);
    console.log('🗓️ Last completed:', lastCompleted.toISOString().split('T')[0]);
    console.log('✅ Is completed today:', isToday);
    
    return isToday;
}

        function updateProgressStats() {
            const completedToday = currentGoals.filter(goal => isGoalCompletedToday(goal)).length;
            const totalGoals = currentGoals.length;
            const longestStreak = currentGoals.length > 0 ? Math.max(...currentGoals.map(g => g.streak || 0)) : 0;
            const progressPercentage = totalGoals > 0 ? Math.round((completedToday / totalGoals) * 100) : 0;
            
            document.getElementById('completedToday').textContent = completedToday;
            document.getElementById('totalGoals').textContent = totalGoals;
            document.getElementById('longestStreak').textContent = longestStreak;
            document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
        }

        function calculateDayCompletion(date) {
            if (currentGoals.length === 0) return 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const checkDate = new Date(date);
            checkDate.setHours(0, 0, 0, 0);
            
            if (checkDate.getTime() === today.getTime()) {
                const completedToday = currentGoals.filter(goal => isGoalCompletedToday(goal)).length;
                return (completedToday / currentGoals.length) * 100;
            }
            
            let completedOnDate = 0;
            currentGoals.forEach(goal => {
                if (goal.lastCompletedDate) {
                    const completedDate = new Date(goal.lastCompletedDate);
                    completedDate.setHours(0, 0, 0, 0);
                    if (completedDate.getTime() === checkDate.getTime()) {
                        completedOnDate++;
                    }
                }
            });
            
            return (completedOnDate / currentGoals.length) * 100;
        }

        function renderWeeklyProgress() {
            const container = document.getElementById('progressChart');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - (6 - i));
                
                const isToday = date.toDateString() === today.toDateString();
                const dayName = days[date.getDay()];
                const dayNumber = date.getDate();
                
                const completionRate = calculateDayCompletion(date);
                
                html += `
                    <div style="
                        text-align: center; 
                        padding: 1rem; 
                        background: ${isToday ? 'var(--primary)' : 'var(--surface)'}; 
                        color: ${isToday ? 'white' : 'var(--text-primary)'}; 
                        border-radius: 12px; 
                        border: 2px solid ${isToday ? 'var(--primary)' : 'var(--border)'};
                        min-width: 80px;
                    ">
                        <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">${dayName}</div>
                        <div style="font-size: 1.2rem; font-weight: 800; margin-bottom: 0.5rem;">${dayNumber}</div>
                        <div style="
                            width: 40px; 
                            height: 40px; 
                            border-radius: 50%; 
                            background: ${isToday ? 'rgba(255,255,255,0.2)' : 'var(--border)'}; 
                            margin: 0 auto; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 0.8rem; 
                            font-weight: 600;
                            color: ${isToday ? 'white' : 'var(--text-secondary)'};
                        ">
                            ${Math.round(completionRate)}%
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function renderMonthlyProgress() {
            const container = document.getElementById('progressChart');
            const today = new Date();
            
            let html = '';
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - (29 - i));
                
                const isToday = date.toDateString() === today.toDateString();
                const dayNumber = date.getDate();
                const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                
                const completionRate = calculateDayCompletion(date);
                
                html += `
                    <div style="
                        text-align: center; 
                        padding: 0.75rem; 
                        background: ${isToday ? 'var(--primary)' : 'var(--surface)'}; 
                        color: ${isToday ? 'white' : 'var(--text-primary)'}; 
                        border-radius: 8px; 
                        border: 1px solid ${isToday ? 'var(--primary)' : 'var(--border)'};
                        min-width: 60px;
                    ">
                        <div style="font-size: 0.7rem; font-weight: 500; margin-bottom: 0.25rem;">${monthName}</div>
                        <div style="font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem;">${dayNumber}</div>
                        <div style="
                            width: 30px; 
                            height: 30px; 
                            border-radius: 50%; 
                            background: ${isToday ? 'rgba(255,255,255,0.2)' : 'var(--border)'}; 
                            margin: 0 auto; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 0.7rem; 
                            font-weight: 600;
                            color: ${isToday ? 'white' : 'var(--text-secondary)'};
                        ">
                            ${Math.round(completionRate)}%
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function showWeeklyProgress() {
            progressView = 'weekly';
            document.getElementById('weeklyBtn').style.background = 'var(--primary)';
            document.getElementById('weeklyBtn').style.color = 'white';
            document.getElementById('monthlyBtn').style.background = 'var(--surface)';
            document.getElementById('monthlyBtn').style.color = 'var(--text-primary)';
            renderWeeklyProgress();
        }

        function showMonthlyProgress() {
            progressView = 'monthly';
            document.getElementById('monthlyBtn').style.background = 'var(--primary)';
            document.getElementById('monthlyBtn').style.color = 'white';
            document.getElementById('weeklyBtn').style.background = 'var(--surface)';
            document.getElementById('weeklyBtn').style.color = 'var(--text-primary)';
            renderMonthlyProgress();
        }

        function renderGoalsByArea() {
            const container = document.getElementById('goalsByArea');
            const areas = ['mind', 'spirit', 'body', 'work', 'relationships', 'fun', 'finances'];
            
            let html = '';
            
            areas.forEach(area => {
                const areaGoals = currentGoals.filter(goal => goal.area === area);
                const completedGoals = areaGoals.filter(goal => isGoalCompletedToday(goal)).length;
                const color = areaColors[area];
                
                if (areaGoals.length > 0) {
                    html += `
                        <div style="
                            padding: 1.5rem; 
                            background: var(--surface); 
                            border-radius: 12px; 
                            border: 1px solid var(--border);
                            border-top: 4px solid ${color};
                        ">
                            <h3 style="
                                margin: 0 0 1rem 0; 
                                color: ${color}; 
                                text-transform: capitalize; 
                                font-weight: 600;
                            ">${area}</h3>
                            <div style="
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center; 
                                margin-bottom: 1rem;
                            ">
                                <span style="color: var(--text-secondary);">Progress</span>
                                <span style="font-weight: 600; color: ${color};">
                                    ${completedGoals}/${areaGoals.length}
                                </span>
                            </div>
                            <div style="
                                width: 100%; 
                                height: 8px; 
                                background: var(--border); 
                                border-radius: 4px; 
                                overflow: hidden;
                            ">
                                <div style="
                                    height: 100%; 
                                    background: ${color}; 
                                    width: ${areaGoals.length > 0 ? (completedGoals / areaGoals.length) * 100 : 0}%; 
                                    transition: width 0.3s ease;
                                "></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = `
                    <div style="
                        grid-column: 1 / -1; 
                        text-align: center; 
                        padding: 2rem; 
                        color: var(--text-muted);
                    ">
                        <p>No goals created yet. <a href="goals.html" style="color: var(--primary);">Create your first goal</a> to see progress by area!</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

async function toggleGoalCompletion(goalId) {
    console.log('🔄 toggleGoalCompletion called with goalId:', goalId);
    
    try {
        const goal = currentGoals.find(g => g._id === goalId);
        console.log('📋 Found goal:', goal);
        
        if (!goal) {
            console.log('❌ No goal found with ID:', goalId);
            return;
        }
        
        const isCurrentlyCompleted = isGoalCompletedToday(goal);
        console.log('✅ Is currently completed:', isCurrentlyCompleted);
        
        const newCompletionState = !isCurrentlyCompleted;
        console.log('🔄 New completion state will be:', newCompletionState);
        
        await updateGoalCompletion(goalId, newCompletionState);
        
        // Show appropriate message
        if (newCompletionState) {
            showSuccess('Goal completed! 🎉');
        } else {
            showSuccess('Goal marked as incomplete.');
        }
        
    } catch (error) {
        console.error('❌ Error toggling goal completion:', error);
        showError('Failed to update goal. Please try again.');
    }
}

       async function updateGoalCompletion(goalId, completed) {
    console.log('🔄 updateGoalCompletion called:', { goalId, completed });
    
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        console.log('🔑 Token found:', !!token);
        
        if (!token) throw new Error('No authentication token');

        const requestBody = {
            completed: completed
        };

        if (completed) {
            requestBody.lastCompletedDate = new Date().toISOString();
        } else {
            requestBody.lastCompletedDate = null;
            requestBody.completed = false;
        }

        console.log('📤 Request body:', requestBody);
        console.log('📍 Making API call to:', `${API_BASE_URL}/api/life-goals/${goalId}`);

        const response = await fetch(`${API_BASE_URL}/api/life-goals/${goalId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        console.log('📥 API Response status:', response.status);
        console.log('📥 API Response ok:', response.ok);

        if (!response.ok) {
            const errorText = await response.text();
            console.log('❌ API Error response:', errorText);
            throw new Error('Failed to update goal');
        }

        const updatedGoal = await response.json();
        console.log('✅ Updated goal received:', updatedGoal);
        
        const goalIndex = currentGoals.findIndex(g => g._id === goalId);
        if (goalIndex !== -1) {
            currentGoals[goalIndex] = updatedGoal;
            console.log('🔄 Local goal updated');
        }
        
        setTimeout(() => {
            console.log('🎨 Re-rendering UI...');
            loadDailyGoals();
            
            if (selectedGoal && selectedGoal._id === goalId) {
                selectedGoal = updatedGoal;
                updateModalButtons();
            }
        }, 100);
        
        showSuccess(completed ? 'Goal marked as complete!' : 'Goal marked as incomplete.');
        
    } catch (error) {
        console.error('❌ Error updating goal:', error);
        throw error;
    }
}

        function openGoalDetail(goalId) {
            const goal = currentGoals.find(g => g._id === goalId);
            if (!goal) return;
            
            selectedGoal = goal;
            const color = areaColors[goal.area] || '#6366f1';
            const isCompleted = isGoalCompletedToday(goal);
            
            document.getElementById('modalTitle').textContent = 'Goal Details';
            document.getElementById('modalArea').textContent = goal.area;
            document.getElementById('modalBigGoal').textContent = goal.bigGoal;
            document.getElementById('modalDailyAction').textContent = goal.dailyAction;
            document.getElementById('modalStreak').textContent = goal.streak || 0;
            
            let lastCompletedText = 'Never';
            if (goal.lastCompletedDate) {
                const lastDate = new Date(goal.lastCompletedDate);
                const today = new Date();
                const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    lastCompletedText = 'Today';
                } else if (diffDays === 1) {
                    lastCompletedText = 'Yesterday';
                } else {
                    lastCompletedText = `${diffDays} days ago`;
                }
            }
            document.getElementById('modalLastCompleted').textContent = lastCompletedText;
            
            document.getElementById('modalHeader').style.background = `linear-gradient(135deg, ${color} 0%, ${adjustBrightness(color, -20)} 100%)`;
            
            updateModalButtons();
            
            document.getElementById('goalDetailModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

function updateModalButtons() {
    if (!selectedGoal) return;
    
    const isCompleted = isGoalCompletedToday(selectedGoal);
    const completeBtn = document.getElementById('markCompleteBtn');
    const incompleteBtn = document.getElementById('markIncompleteBtn');
    
    if (isCompleted) {
        completeBtn.style.display = 'none';
        completeBtn.textContent = 'Complete Today\'s Action';
        incompleteBtn.style.display = 'block';
        incompleteBtn.textContent = 'Mark Incomplete';
    } else {
        completeBtn.style.display = 'block';
        completeBtn.textContent = 'Complete Today\'s Action';
        incompleteBtn.style.display = 'none';
        incompleteBtn.textContent = 'Mark Incomplete';
    }
}

        function closeGoalDetail() {
            document.getElementById('goalDetailModal').style.display = 'none';
            document.body.style.overflow = '';
            selectedGoal = null;
        }

        async function markGoalComplete() {
            if (!selectedGoal) return;
            
            try {
                await updateGoalCompletion(selectedGoal._id, true);
                closeGoalDetail();
                showSuccess('Goal completed! Keep building that streak!');
            } catch (error) {
                console.error('Error marking goal complete:', error);
                showError('Failed to mark goal as complete. Please try again.');
            }
        }

async function markGoalIncomplete() {
    if (!selectedGoal) return;
    
    try {
        await updateGoalCompletion(selectedGoal._id, false);
        closeGoalDetail();
        showSuccess('Goal marked as incomplete.');
    } catch (error) {
                console.error('Error marking goal incomplete:', error);
                // Revert optimistic update
                const originalGoal = currentGoals.find(g => g._id === selectedGoal._id);
                if (originalGoal) {
                    selectedGoal.lastCompletedDate = originalGoal.lastCompletedDate;
                    selectedGoal.completed = originalGoal.completed;
                    updateModalButtons();
                }
                showError('Failed to mark goal as incomplete. Please try again.');
            }
        }

        async function markAllComplete() {
            try {
                const incompleteGoals = currentGoals.filter(goal => !isGoalCompletedToday(goal));
                
                if (incompleteGoals.length === 0) {
                    showSuccess('All goals are already complete for today!');
                    return;
                }
                
                if (!confirm(`Mark all ${incompleteGoals.length} remaining goals as complete for today?`)) {
                    return;
                }
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Completing...';
                button.disabled = true;
                
                for (const goal of incompleteGoals) {
                    await updateGoalCompletion(goal._id, true);
                }
                
                button.textContent = originalText;
                button.disabled = false;
                
                showSuccess('All goals marked as complete! Amazing work today!');
                
            } catch (error) {
                console.error('Error marking all complete:', error);
                showError('Failed to complete all goals. Please try again.');
                
                const button = event.target;
                button.textContent = 'Complete All Today';
                button.disabled = false;
            }
        }

        function adjustBrightness(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'var(--success)' : 'var(--error)';
            
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        function goToNotifications() {
            window.location.href = 'notifications.html';
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        async function updateNotificationCount() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) return;
                
                const response = await fetch(`${API_BASE_URL}/api/notifications/unread-count`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.count || 0;
                    const countElement = document.getElementById('headerNotificationCount');
                    
                    if (countElement) {
                        countElement.textContent = count;
                        countElement.setAttribute('data-count', count);
                        countElement.style.display = count > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error fetching notification count:', error);
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('goalDetailModal').style.display === 'block') {
                closeGoalDetail();
            }
            
            if (e.key === ' ' && selectedGoal && document.getElementById('goalDetailModal').style.display === 'block') {
                e.preventDefault();
                const isCompleted = isGoalCompletedToday(selectedGoal);
                if (isCompleted) {
                    markGoalIncomplete();
                } else {
                    markGoalComplete();
                }
            }
        });

        document.getElementById('goalDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeGoalDetail();
            }
        });

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            @keyframes slideOutRight {
                from { opacity: 1; transform: translateX(0); }
                to { opacity: 0; transform: translateX(100px); }
            }
            
            .goal-tracker-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            }
            
            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid var(--border);
                border-top: 4px solid var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @media (max-width: 768px) {
                .goal-tracker-item {
                    flex-direction: column !important;
                    align-items: stretch !important;
                    text-align: left !important;
                    padding: 1.25rem !important;
                }
                
                .goal-tracker-item > div {
                    margin: 0.5rem 0 !important;
                }
                
                .goal-tracker-item > div:first-child {
                    align-self: flex-start !important;
                    margin-bottom: 1rem !important;
                }
                
                #progressChart {
                    grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)) !important;
                    gap: 0.75rem !important;
                }
                
                #goalsByArea {
                    grid-template-columns: 1fr !important;
                }
                
                .content-header {
                    flex-direction: column !important;
                    align-items: stretch !important;
                    gap: 1rem !important;
                }
                
                .content-header h1 {
                    text-align: center !important;
                    font-size: 1.75rem !important;
                }
                
                .header-actions {
                    justify-content: center !important;
                }
            }
            
            @media (max-width: 480px) {
                #progressChart {
                    grid-template-columns: repeat(auto-fit, minmax(55px, 1fr)) !important;
                    gap: 0.5rem !important;
                }
                
                #progressChart > div {
                    padding: 0.5rem 0.25rem !important;
                    min-width: 50px !important;
                }
                
                .goal-tracker-item {
                    padding: 1rem !important;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
