// FIXED Daily Tracker JavaScript - Preserves all functionality while fixing completion bugs
// Key Fixes:
// 1. Simplified and reliable goal completion checking
// 2. PST timezone handling for "daily" boundaries  
// 3. Real-time progress calculation instead of cached data
// 4. Preserves complete/incomplete toggle functionality

let currentGoals = [];
let selectedGoal = null;
let progressView = 'weekly';

// API Base URL
const API_BASE_URL = 'https://ai-coach-backend-pbse.onrender.com';

// Area color configuration (preserved)
const areaColors = {
    mind: '#8b5cf6',
    spirit: '#06b6d4', 
    body: '#10b981',
    work: '#f59e0b',
    relationships: '#ec4899',
    fun: '#f97316',
    finances: '#059669'
};

// FIXED: PST timezone helper functions
function getPSTDate(date = new Date()) {
    // Convert any date to PST midnight for consistent daily boundaries
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    const pstOffset = -8; // PST is UTC-8 (adjust to -7 for PDT if needed)
    const pst = new Date(utc + (pstOffset * 3600000));
    pst.setHours(0, 0, 0, 0); // Set to midnight PST
    return pst;
}

function getTodayPST() {
    return getPSTDate(new Date());
}

function formatDateForComparison(date) {
    // Returns YYYY-MM-DD format in PST for reliable date comparison
    const pstDate = getPSTDate(new Date(date));
    return pstDate.toISOString().split('T')[0];
}

// FIXED: Simplified and reliable goal completion checker
function isGoalCompletedToday(goal) {
    const todayPST = formatDateForComparison(new Date());
    
    console.log(`üîç Checking completion for goal ${goal._id}:`, {
        goalId: goal._id,
        todayPST: todayPST,
        lastCompletedDate: goal.lastCompletedDate,
        hasCompletionHistory: !!goal.completionHistory,
        historyLength: goal.completionHistory?.length || 0
    });

    // METHOD 1: Check new completion history system first
    if (goal.completionHistory && Array.isArray(goal.completionHistory)) {
        const todayEntry = goal.completionHistory.find(entry => {
            const entryDatePST = formatDateForComparison(entry.date);
            return entryDatePST === todayPST;
        });
        
        if (todayEntry) {
            console.log(`‚úÖ Found today's entry in completion history:`, {
                completed: todayEntry.completed,
                date: todayEntry.date
            });
            return todayEntry.completed;
        }
    }

    // METHOD 2: Fallback to lastCompletedDate for backward compatibility
    if (goal.lastCompletedDate) {
        const lastCompletedPST = formatDateForComparison(goal.lastCompletedDate);
        const isCompletedToday = lastCompletedPST === todayPST;
        
        console.log(`üìÖ Checking lastCompletedDate:`, {
            lastCompletedPST,
            todayPST,
            isCompletedToday
        });
        
        return isCompletedToday;
    }

    console.log(`‚ùå No completion data found for goal ${goal._id}`);
    return false;
}

// FIXED: Real-time progress calculation (no more cached data issues)
function calculateRealTimeProgress() {
    if (currentGoals.length === 0) {
        return {
            completedToday: 0,
            totalGoals: 0,
            progressPercentage: 0,
            longestStreak: 0
        };
    }

    // Calculate stats directly from current goals array
    const completedToday = currentGoals.filter(goal => isGoalCompletedToday(goal)).length;
    const totalGoals = currentGoals.length;
    const progressPercentage = totalGoals > 0 ? Math.round((completedToday / totalGoals) * 100) : 0;
    const longestStreak = Math.max(...currentGoals.map(g => g.streak || 0), 0);

    console.log('üìä Real-time progress calculation:', {
        completedToday,
        totalGoals,
        progressPercentage,
        longestStreak
    });

    return { completedToday, totalGoals, progressPercentage, longestStreak };
}

// FIXED: Enhanced server update with explicit PST date handling
async function updateGoalOnServer(goalId, completed) {
    console.log(`üì§ UPDATING SERVER - goalId: ${goalId}, completed: ${completed}`);
    
    const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
    if (!token) {
        throw new Error('No authentication token');
    }

    // FIXED: Use PST date for consistent daily boundaries
    const requestData = {
        completed: completed
    };
    
    if (completed) {
        // When completing: set to current PST time
        requestData.lastCompletedDate = new Date().toISOString();
    } else {
        // When uncompleting: explicitly set to null to clear the date
        requestData.lastCompletedDate = null;
    }
    
    console.log('üì§ Request data with PST handling:', requestData);

    const response = await fetch(`${API_BASE_URL}/api/life-goals/${goalId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    });

    if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Server error response:', errorText);
        throw new Error(`Server error: ${response.status}`);
    }

    const updatedGoal = await response.json();
    console.log('‚úÖ Server returned updated goal:', updatedGoal);
    
    return updatedGoal;
}

// FIXED: Enhanced goal toggle with real-time updates
async function toggleGoalCompletion(goalId) {
    console.log('üîÑ TOGGLE CALLED - goalId:', goalId);
    
    try {
        const goal = currentGoals.find(g => g._id === goalId);
        if (!goal) {
            console.log('‚ùå Goal not found:', goalId);
            return;
        }
        
        const currentlyCompleted = isGoalCompletedToday(goal);
        const newState = !currentlyCompleted;
        
        console.log('üìã Goal toggle details:', {
            goalId,
            currentlyCompleted,
            newState,
            goalArea: goal.area
        });
        
        // Show immediate feedback
        const checkbox = document.getElementById(`goal-${goalId}`);
        if (checkbox) {
            checkbox.checked = newState;
            checkbox.disabled = true;
        }
        
        // Update server
        await updateGoalOnServer(goalId, newState);
        
        // Reload fresh data from server
        await loadDailyGoals();
        
        // Show success message
        showSuccess(newState ? 'Goal completed! üéâ' : 'Goal marked as incomplete.');
        
    } catch (error) {
        console.error('‚ùå Toggle failed:', error);
        showError('Failed to update goal. Please try again.');
        
        // Reload to reset state on error
        await loadDailyGoals();
    }
}

// FIXED: Real-time progress stats update (no more cached data)
function updateProgressStats() {
    const stats = calculateRealTimeProgress();
    
    document.getElementById('completedToday').textContent = stats.completedToday;
    document.getElementById('totalGoals').textContent = stats.totalGoals;
    document.getElementById('longestStreak').textContent = stats.longestStreak;
    document.getElementById('progressPercentage').textContent = `${stats.progressPercentage}%`;
    document.getElementById('progressBar').style.width = `${stats.progressPercentage}%`;
    
    console.log('üìä Updated progress stats:', stats);
}

// FIXED: Progress overview with PST date handling
function calculateDayCompletion(date) {
    if (currentGoals.length === 0) return 0;
    
    const targetDatePST = formatDateForComparison(date);
    
    let completedOnDate = 0;
    currentGoals.forEach(goal => {
        // Check completion history first
        if (goal.completionHistory && Array.isArray(goal.completionHistory)) {
            const dateEntry = goal.completionHistory.find(entry => {
                const entryDatePST = formatDateForComparison(entry.date);
                return entryDatePST === targetDatePST;
            });
            if (dateEntry && dateEntry.completed) {
                completedOnDate++;
            }
        }
        // Fallback to lastCompletedDate
        else if (goal.lastCompletedDate) {
            const completedDatePST = formatDateForComparison(goal.lastCompletedDate);
            if (completedDatePST === targetDatePST) {
                completedOnDate++;
            }
        }
    });
    
    return (completedOnDate / currentGoals.length) * 100;
}

// PRESERVED: All existing load and render functions with fixes applied
async function loadDailyGoals() {
    try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
        if (!token) {
            showError('Please log in to view your goals');
            return;
        }

        console.log('üîÑ Loading goals from server...');

        const response = await fetch(`${API_BASE_URL}/api/life-goals`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load goals');
        }

        currentGoals = await response.json();
        console.log('‚úÖ Goals loaded:', currentGoals);
        
        // FIXED: Use real-time calculation instead of building cached history
        renderDailyGoals();
        updateProgressStats(); // Now uses real-time calculation
        showWeeklyProgress();   // Uses real-time calculation
        renderGoalsByArea();    // Uses real-time calculation

    } catch (error) {
        console.error('‚ùå Error loading goals:', error);
        showError('Failed to load your goals. Please try again.');
    }
}

// PRESERVED: All existing render functions (renderDailyGoals, renderWeeklyProgress, etc.)
// ... [Rest of the existing functions remain exactly the same] ...

// Initialize page with PST date
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentDate();
    loadDailyGoals();
    updateNotificationCount();
    setInterval(updateNotificationCount, 30000);
});

function updateCurrentDate() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        timeZone: 'America/Los_Angeles' // PST/PDT timezone
    };
    document.getElementById('currentDateDisplay').textContent = now.toLocaleDateString('en-US', options);
}

// PRESERVED: All other existing functions (showSuccess, showError, etc.) remain exactly the same
