<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Universal Hamburger Menu -->
        <button class="universal-hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="menu-item">Dashboard</a></li>
                <li><a href="ai-coach.html" class="menu-item">AI Coach</a></li>
                <li><a href="community.html" class="menu-item active">Community</a></li>
                <li><a href="goals.html" class="menu-item">Goals</a></li>
                <li><a href="daily-tracker.html" class="menu-item">Daily Tracker</a></li>
                <li><a href="billing.html" class="menu-item">Billing</a></li>
                <li><a href="#" class="menu-item" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h1>Community</h1>
                <div class="header-actions">
                    <!-- Desktop Search Bar -->
                    <div class="desktop-search-container desktop-only">
                        <input 
                            type="text" 
                            id="desktopSearchInput" 
                            placeholder="Search messages..." 
                            onkeyup="performSearch(this.value)"
                        />
                    </div>
                    <!-- Notification Icon -->
                    <div class="notification-icon-container" onclick="goToNotifications()">
                        <div class="notification-bell">
                            <svg class="bell-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                        </div>
                    </div>
                    <button class="btn btn-primary desktop-only" onclick="createRoom()">New Room</button>
                </div>
            </header>

            <!-- Community Container - Mobile Responsive Layout -->
            <div class="community-responsive-container">
                
                <!-- Mobile Room Selector -->
                <div class="mobile-room-selector" style="display: none;">
                    <div class="mobile-room-header">
                        <label for="roomDropdown" style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: block;">Choose Room:</label>
                        <select id="roomDropdown" onchange="switchRoom(this.value)" style="
                            width: 100%;
                            padding: 1rem;
                            border: 2px solid var(--border);
                            border-radius: var(--radius);
                            background: var(--background);
                            color: var(--text-primary);
                            font-size: 16px;
                            font-family: inherit;
                            margin-bottom: 1rem;
                        ">
                            <option value="">Select a room...</option>
                        </select>
                        <button onclick="createRoom()" class="btn btn-small" style="width: 100%; margin-bottom: 1rem;">
                            Create New Room
                        </button>
                    </div>
                </div>

                <!-- Desktop Rooms Sidebar -->
                <div class="rooms-sidebar desktop-only">
                    <div class="rooms-header">
                        <h3>Chat Rooms</h3>
                        <button class="btn btn-small" onclick="createRoom()">New</button>
                    </div>
                    
                    <div class="rooms-list" id="roomsList">
                        <!-- Rooms will be populated by JavaScript -->
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <p>Loading rooms...</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Area - Always Visible -->
                <div class="chat-area">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="room-title">
                            <h2 id="currentRoomName">Select a Room</h2>
                            <p id="currentRoomDescription">Choose a room to start chatting</p>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="chat-messages-container">
                        <div class="chat-messages" id="communityMessages">
                            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <h3>Welcome to Community Chat!</h3>
                                <p>Select a room to start the conversation.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="chat-input-area">
                        <!-- Reply Banner (Hidden by default) -->
                        <div id="replyBanner" class="reply-banner" style="display: none;">
                            <div class="reply-content">
                                <div class="reply-header">
                                    <span style="font-size: 0.875rem; color: var(--primary); font-weight: 600;">‚Ü≥ Replying to</span>
                                    <span id="replyToUser" style="font-weight: 600; color: var(--text-primary);"></span>
                                    <button onclick="cancelReply()" class="cancel-reply-btn">√ó</button>
                                </div>
                                <div id="replyToMessage" class="reply-preview"></div>
                            </div>
                        </div>

                        <div class="chat-input">
                            <textarea 
                                id="communityMessageInput" 
                                placeholder="Type your message..." 
                                onkeypress="handleCommunityKeyPress(event)"
                                style="font-size: 16px; resize: none; min-height: 44px; max-height: 120px;"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button class="btn btn-small btn-outline desktop-only" onclick="toggleEmoji()" disabled id="emojiBtn">üòä</button>
                                <button class="btn btn-primary" onclick="sendCommunityMessage()" disabled id="sendCommunityButton">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Search Results (Desktop Only) - EXPLICITLY HIDDEN -->
            <div id="searchResults" class="floating-search-results desktop-only" style="display: none !important;">
                <div class="search-results-header">
                    <h3>Search Results</h3>
                    <button onclick="closeSearch()" class="search-close-btn">√ó</button>
                </div>
                <div id="searchContent" class="search-results-content">
                    <!-- Search results will be populated here -->
                </div>
            </div>

            <!-- Emoji Modal (Desktop Only) - EXPLICITLY HIDDEN -->
            <div id="emojiModal" class="emoji-modal desktop-only" style="display: none !important;">
                <div class="emoji-grid">
                    <button onclick="insertEmoji('üòÄ')" class="emoji-btn">üòÄ</button>
                    <button onclick="insertEmoji('üòÉ')" class="emoji-btn">üòÉ</button>
                    <button onclick="insertEmoji('üòÑ')" class="emoji-btn">üòÑ</button>
                    <button onclick="insertEmoji('üòä')" class="emoji-btn">üòä</button>
                    <button onclick="insertEmoji('üòé')" class="emoji-btn">üòé</button>
                    <button onclick="insertEmoji('üéâ')" class="emoji-btn">üéâ</button>
                    <button onclick="insertEmoji('üëç')" class="emoji-btn">üëç</button>
                    <button onclick="insertEmoji('üëè')" class="emoji-btn">üëè</button>
                    <button onclick="insertEmoji('üí™')" class="emoji-btn">üí™</button>
                    <button onclick="insertEmoji('üöÄ')" class="emoji-btn">üöÄ</button>
                    <button onclick="insertEmoji('üí°')" class="emoji-btn">üí°</button>
                    <button onclick="insertEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none;">
        <div style="text-align: center;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p>Loading community...</p>
        </div>
    </div>

    <script src="sidebar-toggle.js"></script>
    <script src="community.js"></script>

    <style>
        /* Enhanced Message Styling with Like & Reply */
        .message-group {
            position: relative;
            margin-bottom: 1.5rem;
            transition: all 0.2s ease;
        }

        .message-group:hover {
            transform: translateX(2px);
        }

        .message-group:hover .message-actions {
            opacity: 1;
            visibility: visible;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
            font-weight: 600;
        }

        .username {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .message-timestamp {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-left: auto;
        }

        .message-content {
            margin-left: 2.5rem;
            color: var(--text-primary);
            line-height: 1.5;
            background: var(--background);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            position: relative;
        }

        /* Reply Styling */
        .reply-reference {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary);
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 0 6px 6px 0;
            font-size: 0.875rem;
        }

        .reply-author {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .reply-text {
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Message Actions */
        .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.25rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .action-btn {
            background: none;
            border: none;
            padding: 0.375rem;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            font-size: 0.875rem;
        }

        .action-btn:hover {
            background: var(--surface);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .action-btn.liked {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .action-btn.reply-btn:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Message Footer (Like count) */
        .message-footer {
            margin-left: 2.5rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .like-count {
            color: var(--text-muted);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .like-count.has-likes {
            color: #ef4444;
        }

        .reply-count {
            color: var(--text-muted);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Reply Banner Styling */
        .reply-banner {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 0.75rem 1rem;
            border-bottom: none;
        }

        .reply-content {
            position: relative;
        }

        .reply-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .cancel-reply-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            margin-left: auto;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 1rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cancel-reply-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .reply-preview {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-style: italic;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 1024px) {
            .message-actions {
                opacity: 1;
                visibility: visible;
                position: static;
                background: var(--surface);
                margin-top: 0.5rem;
                justify-content: flex-end;
                box-shadow: none;
                border: none;
                padding: 0.5rem;
                border-radius: var(--radius);
            }

            .message-content {
                margin-left: 2rem;
                padding: 0.625rem 0.875rem;
            }

            .message-footer {
                margin-left: 2rem;
            }

            .action-btn {
                min-width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
        }

        /* Animation for new messages */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-group {
            animation: messageSlideIn 0.3s ease-out;
        }

        /* Enhanced chat input when replying */
        .chat-input.replying {
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
        }
    </style>

    <script>
        // Enhanced message interactions
        let currentReplyTo = null;

        // Search functionality (keeping existing)
        let searchTimeout;
        let allMessages = [];

        async function performSearch(query) {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (!query || query.trim().length === 0) {
                closeSearch();
                return;
            }

            searchTimeout = setTimeout(async () => {
                await executeSearch(query.trim());
            }, 300);
        }

        async function executeSearch(query) {
            try {
                const searchResults = document.getElementById('searchResults');
                const searchContent = document.getElementById('searchContent');
                
                if (!searchResults || !searchContent) return;

                searchResults.style.display = 'block';
                searchContent.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                        <p>Searching...</p>
                    </div>
                `;

                if (!currentRoomId) {
                    searchContent.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                            <p>Please select a room first</p>
                        </div>
                    `;
                    return;
                }

                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) {
                    throw new Error('No authentication token');
                }

                const response = await fetch(`https://ai-coach-backend-pbse.onrender.com/api/rooms/${currentRoomId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch messages for search');
                }

                allMessages = await response.json();

                const filteredMessages = allMessages.filter(message => {
                    const content = (message.content || message.message || '').toLowerCase();
                    const username = (message.username || '').toLowerCase();
                    return content.includes(query.toLowerCase()) || username.includes(query.toLowerCase());
                });

                if (filteredMessages.length === 0) {
                    searchContent.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                            <p>No messages found for "${query}"</p>
                        </div>
                    `;
                } else {
                    searchContent.innerHTML = '';
                    
                    filteredMessages.slice(0, 10).forEach(message => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        
                        const content = message.content || message.message || '';
                        const highlightedContent = content.replace(
                            new RegExp(query, 'gi'), 
                            `<mark style="background: #ffd700; color: #000;">${query}</mark>`
                        );
                        
                        const timestamp = formatMessageTime(message.createdAt || message.timestamp);
                        
                        resultItem.innerHTML = `
                            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); cursor: pointer;" onclick="scrollToMessage('${message._id}')">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--primary);">${message.username || 'User'}</strong>
                                    <span style="color: var(--text-muted); font-size: 0.8rem;">${timestamp}</span>
                                </div>
                                <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem; line-height: 1.4;">${highlightedContent}</p>
                            </div>
                        `;
                        
                        searchContent.appendChild(resultItem);
                    });

                    if (filteredMessages.length > 10) {
                        const moreResults = document.createElement('div');
                        moreResults.style.cssText = 'text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.8rem;';
                        moreResults.textContent = `... and ${filteredMessages.length - 10} more results`;
                        searchContent.appendChild(moreResults);
                    }
                }

            } catch (error) {
                console.error('Search error:', error);
                const searchContent = document.getElementById('searchContent');
                if (searchContent) {
                    searchContent.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--error);">
                            <p>Search failed. Please try again.</p>
                        </div>
                    `;
                }
            }
        }

        function scrollToMessage(messageId) {
            closeSearch();
            console.log('Scrolling to message:', messageId);
        }

        function closeSearch() {
            const searchResults = document.getElementById('searchResults');
            const searchInput = document.getElementById('desktopSearchInput');
            
            if (searchResults) {
                searchResults.style.display = 'none';
            }
            
            if (searchInput) {
                searchInput.value = '';
            }
        }

        // Enhanced emoji functions (keeping existing)
        function toggleEmoji() {
            const emojiModal = document.getElementById('emojiModal');
            if (emojiModal) {
                const isVisible = emojiModal.style.display === 'block';
                emojiModal.style.display = isVisible ? 'none' : 'block';
            }
        }

        function insertEmoji(emoji) {
            const messageInput = document.getElementById('communityMessageInput');
            if (messageInput) {
                const cursorPos = messageInput.selectionStart || messageInput.value.length;
                const textBefore = messageInput.value.substring(0, cursorPos);
                const textAfter = messageInput.value.substring(messageInput.selectionEnd || cursorPos);
                messageInput.value = textBefore + emoji + textAfter;
                
                const newPos = cursorPos + emoji.length;
                messageInput.setSelectionRange(newPos, newPos);
                messageInput.focus();
            }
            
            const emojiModal = document.getElementById('emojiModal');
            if (emojiModal) {
                emojiModal.style.display = 'none';
            }
        }

        // NEW: Like functionality
        async function toggleLike(messageId) {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) {
                    throw new Error('No authentication token');
                }

                // Note: This would need a backend endpoint for likes
                // For now, we'll simulate it locally
                console.log('Toggling like for message:', messageId);
                
                // Find the message element and update the like button
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    const likeBtn = messageElement.querySelector('.like-btn');
                    const likeCount = messageElement.querySelector('.like-count');
                    
                    if (likeBtn && likeCount) {
                        const isLiked = likeBtn.classList.contains('liked');
                        const currentCount = parseInt(likeCount.dataset.count || '0');
                        
                        if (isLiked) {
                            likeBtn.classList.remove('liked');
                            likeBtn.innerHTML = '‚ô°';
                            const newCount = Math.max(0, currentCount - 1);
                            updateLikeDisplay(likeCount, newCount);
                        } else {
                            likeBtn.classList.add('liked');
                            likeBtn.innerHTML = '‚ô•';
                            const newCount = currentCount + 1;
                            updateLikeDisplay(likeCount, newCount);
                            
                            // Add haptic feedback on mobile
                            if (navigator.vibrate && window.innerWidth <= 1024) {
                                navigator.vibrate(30);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        function updateLikeDisplay(likeElement, count) {
            likeElement.dataset.count = count;
            
            if (count > 0) {
                likeElement.innerHTML = `‚ô• ${count}`;
                likeElement.classList.add('has-likes');
                likeElement.style.display = 'flex';
            } else {
                likeElement.innerHTML = '';
                likeElement.classList.remove('has-likes');
                likeElement.style.display = 'none';
            }
        }

        // NEW: Reply functionality
        function replyToMessage(messageId, username, content) {
            currentReplyTo = { messageId, username, content };
            
            // Show reply banner
            const replyBanner = document.getElementById('replyBanner');
            const replyToUser = document.getElementById('replyToUser');
            const replyToMessage = document.getElementById('replyToMessage');
            const chatInput = document.querySelector('.chat-input');
            
            if (replyBanner && replyToUser && replyToMessage && chatInput) {
                replyToUser.textContent = username;
                replyToMessage.textContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
                
                replyBanner.style.display = 'block';
                chatInput.classList.add('replying');
                
                // Focus the input
                const messageInput = document.getElementById('communityMessageInput');
                if (messageInput) {
                    messageInput.focus();
                }
                
                // Add haptic feedback on mobile
                if (navigator.vibrate && window.innerWidth <= 1024) {
                    navigator.vibrate(50);
                }
            }
        }

        function cancelReply() {
            currentReplyTo = null;
            
            const replyBanner = document.getElementById('replyBanner');
            const chatInput = document.querySelector('.chat-input');
            
            if (replyBanner) {
                replyBanner.style.display = 'none';
            }
            
            if (chatInput) {
                chatInput.classList.remove('replying');
            }
        }

        // Enhanced message creation with like/reply support
        function createEnhancedMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-group';
            messageDiv.setAttribute('data-message-id', message._id || message.id || Date.now());

            const username = message.username || 'User';
            const userInitials = username.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const timestamp = formatMessageTime(message.createdAt || message.timestamp);
            const content = message.content || message.message || '';
            
            // Check if this is a reply
            let replyHtml = '';
            if (message.replyTo) {
                replyHtml = `
                    <div class="reply-reference">
                        <div class="reply-author">‚Ü≥ ${message.replyTo.username}</div>
                        <div class="reply-text">${message.replyTo.content}</div>
                    </div>
                `;
            }
            
            // Simulate like count (in real app, this would come from backend)
            const likeCount = Math.floor(Math.random() * 3); // Random likes for demo
            const hasLikes = likeCount > 0;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="user-avatar" style="background-color: ${message.avatarColor || '#6366f1'}">
                        ${userInitials}
                    </div>
                    <span class="username">${username}</span>
                    <span class="message-timestamp">${timestamp}</span>
                </div>
                <div class="message-content">
                    ${replyHtml}
                    ${escapeHtml(content)}
                    <div class="message-actions">
                        <button class="action-btn like-btn" onclick="toggleLike('${message._id || message.id || Date.now()}')" title="Like">
                            ‚ô°
                        </button>
                        <button class="action-btn reply-btn" onclick="replyToMessage('${message._id || message.id || Date.now()}', '${username}', '${escapeHtml(content)}')" title="Reply">
                            ‚Ü≥
                        </button>
                    </div>
                </div>
                <div class="message-footer">
                    <div class="like-count" data-count="${likeCount}" style="display: ${hasLikes ? 'flex' : 'none'}">
                        ${hasLikes ? `‚ô• ${likeCount}` : ''}
                    </div>
                </div>
            `;

            return messageDiv;
        }

        // Enhanced send message function with reply support
        async function sendEnhancedCommunityMessage() {
            try {
                const messageInput = document.getElementById('communityMessageInput');
                const sendButton = document.getElementById('sendCommunityButton');
                
                if (!messageInput || !currentRoomId) {
                    console.error('Missing required elements or room not selected');
                    return;
                }

                const messageText = messageInput.value.trim();
                if (!messageText) {
                    return;
                }

                // Show loading state
                if (sendButton) {
                    sendButton.disabled = true;
                    sendButton.textContent = 'Sending...';
                }

                // Add mobile haptic feedback
                if (navigator.vibrate && window.innerWidth <= 1024) {
                    navigator.vibrate(30);
                }

                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) {
                    throw new Error('No authentication token');
                }

                // Prepare message data with reply information
                const messageData = {
                    content: messageText,
                    avatar: getCurrentUser()?.name?.substring(0, 2).toUpperCase() || 'U',
                    avatarColor: '#6366f1'
                };

                // Add reply data if replying
                if (currentReplyTo) {
                    messageData.replyTo = {
                        messageId: currentReplyTo.messageId,
                        username: currentReplyTo.username,
                        content: currentReplyTo.content
                    };
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                // Send message to backend
                const response = await fetch(`https://ai-coach-backend-pbse.onrender.com/api/rooms/${currentRoomId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Failed to send message: ${response.status}`);
                }

                const newMessage = await response.json();
                console.log('Message sent successfully');

                // Clear input and reply state
                messageInput.value = '';
                cancelReply();

                // Hide mobile keyboard
                if (window.innerWidth <= 1024) {
                    messageInput.blur();
                }

                // Reload messages to show the new one
                await loadEnhancedMessages(currentRoomId);

            } catch (error) {
                console.error('Error sending message:', error);
                showErrorMessage('Failed to send message. Please try again.');
            } finally {
                // Re-enable send button
                const sendButton = document.getElementById('sendCommunityButton');
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send';
                }
            }
        }

        // Enhanced message loading with like/reply support
        async function loadEnhancedMessages(roomId) {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) {
                    throw new Error('No authentication token');
                }

                console.log('Loading enhanced messages for room:', roomId);

                const messagesContainer = document.getElementById('communityMessages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <p>Loading messages...</p>
                        </div>
                    `;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const response = await fetch(`https://ai-coach-backend-pbse.onrender.com/api/rooms/${roomId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Failed to load messages: ${response.status}`);
                }

                const messages = await response.json();
                console.log('Loaded enhanced messages for room:', roomId, messages.length);
                
                displayEnhancedMessages(messages);
                
            } catch (error) {
                console.error('Error loading enhanced messages:', error);
                displayEnhancedMessages([]);
            }
        }

        // Enhanced message display
        function displayEnhancedMessages(messages) {
            const messagesContainer = document.getElementById('communityMessages');
            if (!messagesContainer) return;

            messagesContainer.innerHTML = '';

            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <p>No messages yet. Be the first to start the conversation!</p>
                    </div>
                `;
                return;
            }

            messages.forEach(message => {
                const messageElement = createEnhancedMessageElement(message);
                messagesContainer.appendChild(messageElement);
            });

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Utility functions (keeping existing)
        function getCurrentUser() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) return null;
                
                const payload = JSON.parse(atob(token.split('.')[1]));
                return {
                    id: payload.userId,
                    email: payload.email,
                    name: localStorage.getItem('userName') || 'User'
                };
            } catch (error) {
                return null;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return 'Now';
            
            const messageDate = new Date(timestamp);
            const now = new Date();
            const diffInMinutes = Math.floor((now - messageDate) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            
            return messageDate.toLocaleDateString();
        }

        function showErrorMessage(message) {
            const toast = document.createElement('div');
            const isMobile = window.innerWidth <= 1024;
            
            toast.style.cssText = `
                position: fixed;
                ${isMobile ? 'bottom: 20px; left: 20px; right: 20px;' : 'bottom: 20px; right: 20px; max-width: 400px;'}
                background: #ef4444;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 500;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 4000);
        }

        // Mobile-specific responsive fixes (keeping existing)
        function initializeMobileLayout() {
            const isMobile = window.innerWidth <= 1024;
            const mobileSelector = document.querySelector('.mobile-room-selector');
            const desktopSidebar = document.querySelector('.rooms-sidebar');
            const desktopOnlyElements = document.querySelectorAll('.desktop-only');

            if (isMobile) {
                if (mobileSelector) mobileSelector.style.display = 'block';
                if (desktopSidebar) desktopSidebar.style.display = 'none';
                
                desktopOnlyElements.forEach(el => {
                    if (!el.classList.contains('rooms-sidebar')) {
                        el.style.display = 'none';
                    }
                });

                const chatArea = document.querySelector('.chat-area');
                if (chatArea) {
                    chatArea.style.width = '100%';
                    chatArea.style.flex = '1';
                }

                const messageInput = document.getElementById('communityMessageInput');
                if (messageInput) {
                    messageInput.style.fontSize = '16px';
                }

            } else {
                if (mobileSelector) mobileSelector.style.display = 'none';
                if (desktopSidebar) desktopSidebar.style.display = 'flex';
                
                desktopOnlyElements.forEach(el => {
                    el.style.display = '';
                });
            }

            console.log('Mobile layout initialized:', { isMobile, width: window.innerWidth });
        }

        // Enhanced keyboard handling
        function handleCommunityKeyPress(event) {
            if (event.key === 'Enter') {
                const isMobile = window.innerWidth <= 1024;
                
                if (isMobile) {
                    return; // Allow multi-line on mobile
                } else {
                    if (!event.shiftKey) {
                        event.preventDefault();
                        sendEnhancedCommunityMessage();
                    }
                }
            }
            
            // Escape key cancels reply
            if (event.key === 'Escape' && currentReplyTo) {
                cancelReply();
            }
        }

        // Navigation functions (keeping existing)
        function goToNotifications() {
            window.location.href = 'notifications.html';
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Initialize layout on load and resize (keeping existing)
        document.addEventListener('DOMContentLoaded', function() {
            // FORCE HIDE modals immediately
            const searchResults = document.getElementById('searchResults');
            const emojiModal = document.getElementById('emojiModal');
            
            if (searchResults) {
                searchResults.style.display = 'none';
                searchResults.style.visibility = 'hidden';
            }
            
            if (emojiModal) {
                emojiModal.style.display = 'none';
                emojiModal.style.visibility = 'hidden';
            }
            
            initializeMobileLayout();
            
            // Wait for community.js to load
            setTimeout(() => {
                if (window.initializeCommunity) {
                    initializeCommunity();
                }
            }, 100);
        });

        window.addEventListener('resize', initializeMobileLayout);
        window.addEventListener('orientationchange', () => {
            setTimeout(initializeMobileLayout, 100);
        });

        // Close modals when clicking outside (keeping existing)
        document.addEventListener('click', function(event) {
            const emojiModal = document.getElementById('emojiModal');
            const emojiBtn = event.target.closest('#emojiBtn');
            
            if (emojiModal && !emojiModal.contains(event.target) && !emojiBtn) {
                emojiModal.style.display = 'none';
            }

            const searchResults = document.getElementById('searchResults');
            const searchContainer = document.querySelector('.desktop-search-container');
            
            if (searchResults && !searchResults.contains(event.target) && !searchContainer?.contains(event.target)) {
                closeSearch();
            }
        });

        // Add notification count functionality (keeping existing)
        async function updateNotificationCount() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) return;
                
                const response = await fetch('https://ai-coach-backend-pbse.onrender.com/api/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.count || 0;
                    const countElement = document.getElementById('headerNotificationCount');
                    
                    if (countElement) {
                        countElement.textContent = count;
                        countElement.setAttribute('data-count', count);
                        countElement.style.display = count > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error fetching notification count:', error);
            }
        }

        // Update notification count periodically (keeping existing)
        updateNotificationCount();
        setInterval(updateNotificationCount, 30000);

        // Override community.js functions to use enhanced versions
        window.sendCommunityMessage = sendEnhancedCommunityMessage;
        window.loadMessages = loadEnhancedMessages;
        window.displayMessages = displayEnhancedMessages;
        window.createMessageElement = createEnhancedMessageElement;
        window.handleCommunityKeyPress = handleCommunityKeyPress;

        // Make new functions globally available
        window.toggleLike = toggleLike;
        window.replyToMessage = replyToMessage;
        window.cancelReply = cancelReply;
        window.performSearch = performSearch;
        window.closeSearch = closeSearch;
        window.toggleEmoji = toggleEmoji;
        window.insertEmoji = insertEmoji;
        window.goToNotifications = goToNotifications;
        window.logout = logout;
        window.formatMessageTime = formatMessageTime;
        window.showErrorMessage = showErrorMessage;

        console.log('‚úÖ Enhanced Community with Like & Reply loaded!');
    </script>

</body>
</html>
