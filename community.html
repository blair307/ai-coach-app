<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Universal Hamburger Menu -->
        <button class="universal-hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="menu-item">Dashboard</a></li>
                <li><a href="ai-coach.html" class="menu-item">AI Coach</a></li>
                <li><a href="community.html" class="menu-item active">Community</a></li>
                <li><a href="goals.html" class="menu-item">Goals</a></li>
                <li><a href="daily-tracker.html" class="menu-item">Daily Tracker</a></li>
                <li><a href="billing.html" class="menu-item">Billing</a></li>
                <li><a href="#" class="menu-item" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h1>Community</h1>
                <div class="header-actions">
                    <!-- Notification Icon -->
                    <div class="notification-icon-container" onclick="goToNotifications()">
                        <div class="notification-bell">
                            <svg class="bell-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                        </div>
                    </div>
                    <button class="btn btn-primary desktop-only" onclick="createRoom()">New Room</button>
                </div>
            </header>

            <!-- Community Container - Mobile Responsive Layout -->
            <div class="community-responsive-container">
                
                <!-- Mobile Room Selector -->
                <div class="mobile-room-selector" style="display: none;">
                    <div class="mobile-room-header">
                        <label for="roomDropdown" style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: block;">Choose Room:</label>
                        <select id="roomDropdown" onchange="switchRoom(this.value)" style="
                            width: 100%;
                            padding: 1rem;
                            border: 2px solid var(--border);
                            border-radius: var(--radius);
                            background: var(--background);
                            color: var(--text-primary);
                            font-size: 16px;
                            font-family: inherit;
                            margin-bottom: 1rem;
                        ">
                            <option value="">Select a room...</option>
                        </select>
                        <button onclick="createRoom()" class="btn btn-small" style="width: 100%; margin-bottom: 1rem;">
                            Create New Room
                        </button>
                    </div>
                </div>

                <!-- Desktop Rooms Sidebar -->
                <div class="rooms-sidebar desktop-only">
                    <div class="rooms-header">
                        <h3>Chat Rooms</h3>
                        <button class="btn btn-small" onclick="createRoom()">New</button>
                    </div>
                    
                    <!-- Desktop Search Bar -->
                    <div class="search-container desktop-only" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search messages..." 
                            onkeyup="performSearch(this.value)"
                            style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 2px solid var(--border);
                                border-radius: var(--radius);
                                background: var(--background);
                                color: var(--text-primary);
                                font-size: 0.9rem;
                                font-family: inherit;
                            "
                        />
                    </div>
                    
                    <div class="rooms-list" id="roomsList">
                        <!-- Rooms will be populated by JavaScript -->
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <p>Loading rooms...</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Area - Always Visible -->
                <div class="chat-area">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="room-title">
                            <h2 id="currentRoomName">Select a Room</h2>
                            <p id="currentRoomDescription">Choose a room to start chatting</p>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="chat-messages-container">
                        <div class="chat-messages" id="communityMessages">
                            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <h3>Welcome to Community Chat!</h3>
                                <p>Select a room to start the conversation.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="chat-input-area">
                        <div class="chat-input">
                            <textarea 
                                id="communityMessageInput" 
                                placeholder="Type your message..." 
                                onkeypress="handleCommunityKeyPress(event)"
                                style="font-size: 16px; resize: none; min-height: 44px; max-height: 120px;"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button class="btn btn-small btn-outline desktop-only" onclick="toggleEmoji()" disabled id="emojiBtn">üòä</button>
                                <button class="btn btn-primary" onclick="sendCommunityMessage()" disabled id="sendCommunityButton">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Search Results (Desktop Only) -->
            <div id="searchResults" class="floating-search-results desktop-only" style="display: none;">
                <div class="search-results-header">
                    <h3>Search Results</h3>
                    <button onclick="closeSearch()" class="search-close-btn">√ó</button>
                </div>
                <div id="searchContent" class="search-results-content">
                    <!-- Search results will be populated here -->
                </div>
            </div>

            <!-- Emoji Modal (Desktop Only) - FIXED: Hidden by default -->
            <div id="emojiModal" class="emoji-modal desktop-only" style="display: none;">
                <div class="emoji-grid">
                    <button onclick="insertEmoji('üòÄ')" class="emoji-btn">üòÄ</button>
                    <button onclick="insertEmoji('üòÉ')" class="emoji-btn">üòÉ</button>
                    <button onclick="insertEmoji('üòÑ')" class="emoji-btn">üòÑ</button>
                    <button onclick="insertEmoji('üòä')" class="emoji-btn">üòä</button>
                    <button onclick="insertEmoji('üòé')" class="emoji-btn">üòé</button>
                    <button onclick="insertEmoji('üéâ')" class="emoji-btn">üéâ</button>
                    <button onclick="insertEmoji('üëç')" class="emoji-btn">üëç</button>
                    <button onclick="insertEmoji('üëè')" class="emoji-btn">üëè</button>
                    <button onclick="insertEmoji('üí™')" class="emoji-btn">üí™</button>
                    <button onclick="insertEmoji('üöÄ')" class="emoji-btn">üöÄ</button>
                    <button onclick="insertEmoji('üí°')" class="emoji-btn">üí°</button>
                    <button onclick="insertEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none;">
        <div style="text-align: center;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p>Loading community...</p>
        </div>
    </div>

    <script src="sidebar-toggle.js"></script>
    <script src="community.js"></script>

    <script>
        // Search functionality
        let searchTimeout;
        let allMessages = [];

        async function performSearch(query) {
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // If empty query, hide results
            if (!query || query.trim().length === 0) {
                closeSearch();
                return;
            }

            // Debounce search
            searchTimeout = setTimeout(async () => {
                await executeSearch(query.trim());
            }, 300);
        }

        async function executeSearch(query) {
            try {
                const searchResults = document.getElementById('searchResults');
                const searchContent = document.getElementById('searchContent');
                
                if (!searchResults || !searchContent) return;

                // Show loading in search results
                searchResults.style.display = 'block';
                searchContent.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                        <p>Searching...</p>
                    </div>
                `;

                // Get all messages from current room
                if (!currentRoomId) {
                    searchContent.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                            <p>Please select a room first</p>
                        </div>
                    `;
                    return;
                }

                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) {
                    throw new Error('No authentication token');
                }

                const response = await fetch(`https://ai-coach-backend-pbse.onrender.com/api/rooms/${currentRoomId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch messages for search');
                }

                allMessages = await response.json();

                // Filter messages based on query
                const filteredMessages = allMessages.filter(message => {
                    const content = (message.content || message.message || '').toLowerCase();
                    const username = (message.username || '').toLowerCase();
                    return content.includes(query.toLowerCase()) || username.includes(query.toLowerCase());
                });

                // Display results
                if (filteredMessages.length === 0) {
                    searchContent.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                            <p>No messages found for "${query}"</p>
                        </div>
                    `;
                } else {
                    searchContent.innerHTML = '';
                    
                    filteredMessages.slice(0, 10).forEach(message => { // Limit to 10 results
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        
                        const content = message.content || message.message || '';
                        const highlightedContent = content.replace(
                            new RegExp(query, 'gi'), 
                            `<mark style="background: #ffd700; color: #000;">${query}</mark>`
                        );
                        
                        const timestamp = formatMessageTime(message.createdAt || message.timestamp);
                        
                        resultItem.innerHTML = `
                            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); cursor: pointer;" onclick="scrollToMessage('${message._id}')">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--primary);">${message.username || 'User'}</strong>
                                    <span style="color: var(--text-muted); font-size: 0.8rem;">${timestamp}</span>
                                </div>
                                <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem; line-height: 1.4;">${highlightedContent}</p>
                            </div>
                        `;
                        
                        searchContent.appendChild(resultItem);
                    });

                    if (filteredMessages.length > 10) {
                        const moreResults = document.createElement('div');
                        moreResults.style.cssText = 'text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.8rem;';
                        moreResults.textContent = `... and ${filteredMessages.length - 10} more results`;
                        searchContent.appendChild(moreResults);
                    }
                }

            } catch (error) {
                console.error('Search error:', error);
                const searchContent = document.getElementById('searchContent');
                if (searchContent) {
                    searchContent.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--error);">
                            <p>Search failed. Please try again.</p>
                        </div>
                    `;
                }
            }
        }

        function scrollToMessage(messageId) {
            // Close search and try to scroll to message
            closeSearch();
            // In a real implementation, you'd scroll to the specific message
            console.log('Scrolling to message:', messageId);
        }

        function closeSearch() {
            const searchResults = document.getElementById('searchResults');
            const searchInput = document.getElementById('searchInput');
            
            if (searchResults) {
                searchResults.style.display = 'none';
            }
            
            if (searchInput) {
                searchInput.value = '';
            }
        }

        // Enhanced emoji functions
        function toggleEmoji() {
            const emojiModal = document.getElementById('emojiModal');
            if (emojiModal) {
                const isVisible = emojiModal.style.display === 'block';
                emojiModal.style.display = isVisible ? 'none' : 'block';
            }
        }

        function insertEmoji(emoji) {
            const messageInput = document.getElementById('communityMessageInput');
            if (messageInput) {
                const cursorPos = messageInput.selectionStart || messageInput.value.length;
                const textBefore = messageInput.value.substring(0, cursorPos);
                const textAfter = messageInput.value.substring(messageInput.selectionEnd || cursorPos);
                messageInput.value = textBefore + emoji + textAfter;
                
                const newPos = cursorPos + emoji.length;
                messageInput.setSelectionRange(newPos, newPos);
                messageInput.focus();
            }
            
            // Close emoji modal
            const emojiModal = document.getElementById('emojiModal');
            if (emojiModal) {
                emojiModal.style.display = 'none';
            }
        }

        // Mobile-specific responsive fixes
        function initializeMobileLayout() {
            const isMobile = window.innerWidth <= 1024;
            const mobileSelector = document.querySelector('.mobile-room-selector');
            const desktopSidebar = document.querySelector('.rooms-sidebar');
            const desktopOnlyElements = document.querySelectorAll('.desktop-only');

            if (isMobile) {
                // Show mobile layout
                if (mobileSelector) mobileSelector.style.display = 'block';
                if (desktopSidebar) desktopSidebar.style.display = 'none';
                
                // Hide desktop-only elements
                desktopOnlyElements.forEach(el => {
                    if (!el.classList.contains('rooms-sidebar')) {
                        el.style.display = 'none';
                    }
                });

                // Adjust chat area for mobile
                const chatArea = document.querySelector('.chat-area');
                if (chatArea) {
                    chatArea.style.width = '100%';
                    chatArea.style.flex = '1';
                }

                // Prevent iOS zoom on input
                const messageInput = document.getElementById('communityMessageInput');
                if (messageInput) {
                    messageInput.style.fontSize = '16px';
                }

            } else {
                // Show desktop layout
                if (mobileSelector) mobileSelector.style.display = 'none';
                if (desktopSidebar) desktopSidebar.style.display = 'flex';
                
                // Show desktop-only elements
                desktopOnlyElements.forEach(el => {
                    el.style.display = '';
                });
            }

            console.log('Mobile layout initialized:', { isMobile, width: window.innerWidth });
        }

        // Enhanced room switching for mobile dropdown
        function updateMobileRoomDropdown() {
            const dropdown = document.getElementById('roomDropdown');
            if (!dropdown || !window.rooms) return;

            dropdown.innerHTML = '<option value="">Select a room...</option>';
            
            window.rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room._id;
                option.textContent = room.name;
                option.selected = room._id === window.currentRoomId;
                dropdown.appendChild(option);
            });
        }

        // Enhanced navigation functions
        function goToNotifications() {
            window.location.href = 'notifications.html';
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Helper function for time formatting
        function formatMessageTime(timestamp) {
            if (!timestamp) return 'Now';
            
            const messageDate = new Date(timestamp);
            const now = new Date();
            const diffInMinutes = Math.floor((now - messageDate) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            
            return messageDate.toLocaleDateString();
        }

        // Initialize layout on load and resize
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileLayout();
            
            // Wait for community.js to load
            setTimeout(() => {
                if (window.initializeCommunity) {
                    initializeCommunity();
                }
            }, 100);
        });

        window.addEventListener('resize', initializeMobileLayout);
        window.addEventListener('orientationchange', () => {
            setTimeout(initializeMobileLayout, 100);
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            // Close emoji modal
            const emojiModal = document.getElementById('emojiModal');
            const emojiBtn = event.target.closest('#emojiBtn');
            
            if (emojiModal && !emojiModal.contains(event.target) && !emojiBtn) {
                emojiModal.style.display = 'none';
            }

            // Close search results when clicking outside
            const searchResults = document.getElementById('searchResults');
            const searchContainer = document.querySelector('.search-container');
            
            if (searchResults && !searchResults.contains(event.target) && !searchContainer?.contains(event.target)) {
                closeSearch();
            }
        });

        // Add notification count functionality
        async function updateNotificationCount() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) return;
                
                const response = await fetch('https://ai-coach-backend-pbse.onrender.com/api/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.count || 0;
                    const countElement = document.getElementById('headerNotificationCount');
                    
                    if (countElement) {
                        countElement.textContent = count;
                        countElement.setAttribute('data-count', count);
                        countElement.style.display = count > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error fetching notification count:', error);
            }
        }

        // Update notification count periodically
        updateNotificationCount();
        setInterval(updateNotificationCount, 30000);

        // Make functions globally available
