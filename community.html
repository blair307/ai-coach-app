// Updated community.js - Replace localStorage with database API calls

// Global variables
let currentRooms = [];
let currentRoom = null;
let currentMessages = [];

// Load rooms from database on page load
async function loadRooms() {
    try {
        currentRooms = await window.roomsAPI.getAll();
        renderRoomsList();
        
        // Load first room or default room
        if (currentRooms.length > 0) {
            const defaultRoom = currentRooms.find(r => r.name === 'General Discussion') || currentRooms[0];
            switchRoom(defaultRoom._id, defaultRoom.name, defaultRoom.description);
        }
    } catch (error) {
        console.error('Error loading rooms:', error);
        window.handleAPIError(error);
        // Fallback to empty state
        currentRooms = [];
        renderRoomsList();
    }
}

// Render rooms list in sidebar
function renderRoomsList() {
    const roomsList = document.getElementById('roomsList');
    
    if (currentRooms.length === 0) {
        roomsList.innerHTML = `
            <div class="no-rooms">
                <p>No chat rooms yet</p>
                <button class="btn btn-small btn-primary" onclick="createRoom()">Create First Room</button>
            </div>
        `;
        return;
    }
    
    roomsList.innerHTML = currentRooms.map(room => `
        <div class="room-item ${currentRoom && currentRoom._id === room._id ? 'active' : ''}" 
             data-room-id="${room._id}" 
             onclick="switchRoom('${room._id}', '${room.name}', '${room.description}')">
            <div class="room-info">
                <h4>${room.name}</h4>
                <p>${room.description}</p>
            </div>
            <div class="room-stats">
                <span class="message-count">${room.messageCount || 0}</span>
                ${!room.isDefault ? `<button class="delete-room-btn" onclick="deleteRoom(event, '${room._id}')" title="Delete Room">Ã—</button>` : ''}
            </div>
        </div>
    `).join('');
}

// Switch to a different room
async function switchRoom(roomId, roomName, roomDescription) {
    try {
        currentRoom = { _id: roomId, name: roomName, description: roomDescription };
        
        // Update UI
        document.getElementById('currentRoomName').textContent = roomName;
        document.getElementById('currentRoomDescription').textContent = roomDescription;
        
        // Update active room in sidebar
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-room-id="${roomId}"]`)?.classList.add('active');
        
        // Load messages for this room
        await loadRoomMessages(roomId);
        
        // Clear any active search
        clearSearch();
        
    } catch (error) {
        console.error('Error switching room:', error);
        window.handleAPIError(error);
    }
}

// Load messages for a specific room
async function loadRoomMessages(roomId) {
    try {
        showMessagesLoading();
        currentMessages = await window.roomsAPI.getMessages(roomId);
        renderMessages();
    } catch (error) {
        console.error('Error loading messages:', error);
        window.handleAPIError(error);
        // Fallback to empty state
        currentMessages = [];
        renderMessages();
    }
}

// Render messages in chat area
function renderMessages() {
    const messagesContainer = document.getElementById('communityMessages');
    
    if (currentMessages.length === 0) {
        messagesContainer.innerHTML = `
            <div class="empty-room">
                <p>This room is ready for conversation!</p>
                <p>Be the first to share something with the ${currentRoom?.name?.toLowerCase() || 'community'}.</p>
            </div>
        `;
        return;
    }
    
    messagesContainer.innerHTML = currentMessages.map(message => `
        <div class="message-group" data-searchable="${createSearchableText(message)}">
            <div class="message-header">
                <div class="user-avatar" style="background: ${message.avatarColor || '#6366f1'};">
                    ${message.avatar || message.username?.charAt(0) || 'U'}
                </div>
                <span class="username">${message.username || 'User'}</span>
                <span class="message-timestamp">${formatMessageTime(message.createdAt || message.timestamp)}</span>
            </div>
            <div class="message-content">${message.content || message.message || ''}</div>
        </div>
    `).join('');
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Create searchable text for message
function createSearchableText(message) {
    return `${message.username || ''} ${message.content || message.message || ''}`.toLowerCase();
}

// Format message time
function formatMessageTime(dateString) {
    if (!dateString) return 'Unknown time';
    
    const date = new Date(dateString);
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    
    const timeString = date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
    
    if (messageDate.getTime() === today.getTime()) {
        return timeString;
    } else if (messageDate.getTime() === today.getTime() - 86400000) {
        return `Yesterday ${timeString}`;
    } else {
        return `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} ${timeString}`;
    }
}

// Send message to current room
async function sendCommunityMessage() {
    const input = document.getElementById('communityMessageInput');
    const message = input.value.trim();
    
    if (!message || !currentRoom) {
        return;
    }
    
    try {
        showSendingState();
        
        const newMessage = await window.roomsAPI.sendMessage(currentRoom._id, {
            content: message,
            avatar: 'YU', // You can customize this
            avatarColor: '#6366f1'
        });
        
        // Add message to current messages
        currentMessages.push(newMessage);
        
        // Re-render messages
        renderMessages();
        
        // Clear input
        input.value = '';
        
        // Update room message count
        const room = currentRooms.find(r => r._id === currentRoom._id);
        if (room) {
            room.messageCount = (room.messageCount || 0) + 1;
            renderRoomsList();
        }
        
        console.log('Message sent successfully');
        
    } catch (error) {
        console.error('Error sending message:', error);
        window.handleAPIError(error);
        showToast('Failed to send message. Please try again.', 'error');
    } finally {
        hideSendingState();
    }
}

// Create new room
async function createRoom() {
    const name = prompt('Enter room name:');
    if (!name || !name.trim()) return;
    
    const description = prompt('Enter room description:') || 'Custom chat room';
    
    try {
        showToast('Creating room...', 'info');
        
        const newRoom = await window.roomsAPI.create({
            name: name.trim(),
            description: description.trim()
        });
        
        // Add to current rooms
        currentRooms.push({
            ...newRoom,
            messageCount: 0
        });
        
        renderRoomsList();
        showToast('Room created successfully!', 'success');
        
        // Switch to the new room
        switchRoom(newRoom._id, newRoom.name, newRoom.description);
        
    } catch (error) {
        console.error('Error creating room:', error);
        window.handleAPIError(error);
        showToast('Failed to create room. Please try again.', 'error');
    }
}

// Delete room
async function deleteRoom(event, roomId) {
    event.stopPropagation(); // Prevent room switching
    
    const room = currentRooms.find(r => r._id === roomId);
    if (!room) return;
    
    if (!confirm(`Are you sure you want to delete "${room.name}"? This will delete all messages in the room.`)) {
        return;
    }
    
    try {
        await window.roomsAPI.delete(roomId);
        
        // Remove from current rooms
        currentRooms = currentRooms.filter(r => r._id !== roomId);
        
        // If we're currently in this room, switch to another room
        if (currentRoom && currentRoom._id === roomId) {
            if (currentRooms.length > 0) {
                const defaultRoom = currentRooms.find(r => r.name === 'General Discussion') || currentRooms[0];
                switchRoom(defaultRoom._id, defaultRoom.name, defaultRoom.description);
            } else {
                currentRoom = null;
                currentMessages = [];
                renderMessages();
            }
        }
        
        renderRoomsList();
        showToast('Room deleted successfully', 'success');
        
    } catch (error) {
        console.error('Error deleting room:', error);
        window.handleAPIError(error);
        showToast('Failed to delete room. You might not have permission.', 'error');
    }
}

// Search functionality
function searchMessages(query) {
    const searchResults = document.getElementById('searchResults');
    const searchResultsContent = document.getElementById('searchResultsContent');
    const chatMessages = document.getElementById('communityMessages');
    
    if (query.length < 2) {
        clearSearch();
        return;
    }
    
    const results = currentMessages.filter(message => {
        const searchableText = createSearchableText(message);
        return searchableText.includes(query.toLowerCase());
    });
    
    if (results.length > 0) {
        searchResultsContent.innerHTML = results.map(result => `
            <div class="search-result-item">
                <div class="result-header">
                    <div class="user-avatar" style="background: ${result.avatarColor || '#6366f1'};">
                        ${result.avatar || result.username?.charAt(0) || 'U'}
                    </div>
                    <span class="username">${result.username || 'User'}</span>
                    <span class="timestamp">${formatMessageTime(result.createdAt || result.timestamp)}</span>
                </div>
                <div class="result-content">${highlightQuery(result.content || result.message || '', query)}</div>
            </div>
        `).join('');
        
        searchResults.style.display = 'block';
        chatMessages.style.display = 'none';
    } else {
        searchResultsContent.innerHTML = `<div class="no-results">No messages found for "${query}"</div>`;
        searchResults.style.display = 'block';
        chatMessages.style.display = 'none';
    }
}

function highlightQuery(text, query) {
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function performSearch() {
    const query = document.getElementById('messageSearch').value;
    searchMessages(query);
}

function clearSearch() {
    const searchResults = document.getElementById('searchResults');
    const chatMessages = document.getElementById('communityMessages');
    const searchInput = document.getElementById('messageSearch');
    
    if (searchResults) searchResults.style.display = 'none';
    if (chatMessages) chatMessages.style.display = 'block';
    if (searchInput) searchInput.value = '';
}

// Message input handling
function handleCommunityKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendCommunityMessage();
    }
}

// Emoji functionality
function addEmoji() {
    const emojiModal = document.getElementById('emojiModal');
    emojiModal.style.display = emojiModal.style.display === 'block' ? 'none' : 'block';
}

function insertEmoji(emoji) {
    const input = document.getElementById('communityMessageInput');
    input.value += emoji;
    document.getElementById('emojiModal').style.display = 'none';
    input.focus();
}

// Utility functions
function showMessagesLoading() {
    const messagesContainer = document.getElementById('communityMessages');
    messagesContainer.innerHTML = '<div class="loading-spinner">Loading messages...</div>';
}

function showSendingState() {
    const sendButton = document.getElementById('sendCommunityButton');
    if (sendButton) {
        sendButton.textContent = 'Sending...';
        sendButton.disabled = true;
    }
}

function hideSendingState() {
    const sendButton = document.getElementById('sendCommunityButton');
    if (sendButton) {
        sendButton.textContent = 'Send';
        sendButton.disabled = false;
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#6366f1'
    };
    
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('eeh_token');
    localStorage.removeItem('userData');
    window.location.href = 'login.html';
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // Load rooms from database
    loadRooms();
    
    // Add event listeners
    const messageInput = document.getElementById('communityMessageInput');
    if (messageInput) {
        messageInput.addEventListener('keypress', handleCommunityKeyPress);
    }
    
    const searchInput = document.getElementById('messageSearch');
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            } else {
                searchMessages(this.value);
            }
        });
    }
    
    // Close emoji modal when clicking outside
    document.addEventListener('click', function(e) {
        const emojiModal = document.getElementById('emojiModal');
        if (emojiModal && !e.target.closest('.emoji-modal') && !e.target.closest('[onclick*="addEmoji"]')) {
            emojiModal.style.display = 'none';
        }
    });
    
    console.log('Community page initialized with database');
});

// Export functions for global access
window.switchRoom = switchRoom;
window.createRoom = createRoom;
window.deleteRoom = deleteRoom;
window.sendCommunityMessage = sendCommunityMessage;
window.searchMessages = searchMessages;
window.performSearch = performSearch;
window.clearSearch = clearSearch;
window.handleCommunityKeyPress = handleCommunityKeyPress;
window.addEmoji = addEmoji;
window.insertEmoji = insertEmoji;
window.logout = logout;
