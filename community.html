<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Universal Hamburger Menu -->
        <button class="universal-hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="menu-item">Dashboard</a></li>
                <li><a href="ai-coach.html" class="menu-item">AI Coach</a></li>
                <li><a href="community.html" class="menu-item active">Community</a></li>
                <li><a href="goals.html" class="menu-item">Goals</a></li>
                <li><a href="daily-tracker.html" class="menu-item">Daily Tracker</a></li>
                <li><a href="billing.html" class="menu-item">Billing</a></li>
                <li><a href="#" class="menu-item" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h1>Community</h1>
                <div class="header-actions">
                    <!-- Notification Icon -->
                    <div class="notification-icon-container" onclick="goToNotifications()">
                        <div class="notification-bell">
                            <svg class="bell-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                        </div>
                    </div>
                    <button class="btn btn-primary desktop-only" onclick="createRoom()">New Room</button>
                </div>
            </header>

            <!-- Community Container - Mobile Responsive Layout -->
            <div class="community-responsive-container">
                
                <!-- Mobile Room Selector -->
                <div class="mobile-room-selector" style="display: none;">
                    <div class="mobile-room-header">
                        <label for="roomDropdown" style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: block;">Choose Room:</label>
                        <select id="roomDropdown" onchange="switchRoom(this.value)" style="
                            width: 100%;
                            padding: 1rem;
                            border: 2px solid var(--border);
                            border-radius: var(--radius);
                            background: var(--background);
                            color: var(--text-primary);
                            font-size: 16px;
                            font-family: inherit;
                            margin-bottom: 1rem;
                        ">
                            <option value="">Select a room...</option>
                        </select>
                        <button onclick="createRoom()" class="btn btn-small" style="width: 100%; margin-bottom: 1rem;">
                            Create New Room
                        </button>
                    </div>
                </div>

                <!-- Desktop Rooms Sidebar -->
                <div class="rooms-sidebar desktop-only">
                    <div class="rooms-header">
                        <h3>Chat Rooms</h3>
                        <button class="btn btn-small" onclick="createRoom()">New</button>
                    </div>
                    <div class="rooms-list" id="roomsList">
                        <!-- Rooms will be populated by JavaScript -->
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <p>Loading rooms...</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Area - Always Visible -->
                <div class="chat-area">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="room-title">
                            <h2 id="currentRoomName">Select a Room</h2>
                            <p id="currentRoomDescription">Choose a room to start chatting</p>
                        </div>
                        <div class="chat-controls desktop-only">
                            <button class="btn btn-small btn-outline" onclick="performSearch()" style="display: none;">Search</button>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="chat-messages-container">
                        <div class="chat-messages" id="communityMessages">
                            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <h3>Welcome to Community Chat!</h3>
                                <p>Select a room to start the conversation.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="chat-input-area">
                        <div class="chat-input">
                            <textarea 
                                id="communityMessageInput" 
                                placeholder="Type your message..." 
                                onkeypress="handleCommunityKeyPress(event)"
                                style="font-size: 16px; resize: none; min-height: 44px; max-height: 120px;"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button class="btn btn-small btn-outline desktop-only" onclick="addEmoji()" disabled id="emojiBtn">üòä</button>
                                <button class="btn btn-primary" onclick="sendCommunityMessage()" disabled id="sendCommunityButton">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop Search Results (Hidden by default) -->
            <div id="searchResults" class="search-results desktop-only" style="display: none;">
                <div class="search-header">
                    <h3>Search Results</h3>
                    <button onclick="closeSearch()" class="btn btn-small">Close</button>
                </div>
                <div id="searchContent" class="search-content">
                    <!-- Search results will be populated here -->
                </div>
            </div>

            <!-- Emoji Modal (Desktop Only) -->
            <div id="emojiModal" class="desktop-only" style="
                display: none;
                position: absolute;
                bottom: 100px;
                right: 20px;
                background: var(--background);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 1rem;
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                max-width: 300px;
                max-height: 200px;
                overflow-y: auto;
            ">
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                    <button onclick="insertEmoji('üòÄ')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üòÄ</button>
                    <button onclick="insertEmoji('üòÉ')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üòÉ</button>
                    <button onclick="insertEmoji('üòÑ')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üòÑ</button>
                    <button onclick="insertEmoji('üòä')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üòä</button>
                    <button onclick="insertEmoji('üòé')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üòé</button>
                    <button onclick="insertEmoji('üéâ')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üéâ</button>
                    <button onclick="insertEmoji('üëç')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üëç</button>
                    <button onclick="insertEmoji('üëè')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üëè</button>
                    <button onclick="insertEmoji('üí™')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üí™</button>
                    <button onclick="insertEmoji('üöÄ')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üöÄ</button>
                    <button onclick="insertEmoji('üí°')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">üí°</button>
                    <button onclick="insertEmoji('‚ù§Ô∏è')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px;">‚ù§Ô∏è</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        backdrop-filter: blur(4px);
    ">
        <div style="text-align: center;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p>Loading community...</p>
        </div>
    </div>

    <script src="sidebar-toggle.js"></script>
    <script src="community.js"></script>

    <script>
        // Mobile-specific responsive fixes
        function initializeMobileLayout() {
            const isMobile = window.innerWidth <= 1024;
            const mobileSelector = document.querySelector('.mobile-room-selector');
            const desktopSidebar = document.querySelector('.rooms-sidebar');
            const desktopOnlyElements = document.querySelectorAll('.desktop-only');

            if (isMobile) {
                // Show mobile layout
                if (mobileSelector) mobileSelector.style.display = 'block';
                if (desktopSidebar) desktopSidebar.style.display = 'none';
                
                // Hide desktop-only elements
                desktopOnlyElements.forEach(el => {
                    if (!el.classList.contains('rooms-sidebar')) {
                        el.style.display = 'none';
                    }
                });

                // Adjust chat area for mobile
                const chatArea = document.querySelector('.chat-area');
                if (chatArea) {
                    chatArea.style.width = '100%';
                    chatArea.style.flex = '1';
                }

                // Prevent iOS zoom on input
                const messageInput = document.getElementById('communityMessageInput');
                if (messageInput) {
                    messageInput.style.fontSize = '16px';
                }

            } else {
                // Show desktop layout
                if (mobileSelector) mobileSelector.style.display = 'none';
                if (desktopSidebar) desktopSidebar.style.display = 'flex';
                
                // Show desktop-only elements
                desktopOnlyElements.forEach(el => {
                    el.style.display = '';
                });
            }

            console.log('Mobile layout initialized:', { isMobile, width: window.innerWidth });
        }

        // Enhanced room switching for mobile dropdown
        function updateMobileRoomDropdown() {
            const dropdown = document.getElementById('roomDropdown');
            if (!dropdown || !rooms) return;

            dropdown.innerHTML = '<option value="">Select a room...</option>';
            
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room._id;
                option.textContent = room.name;
                option.selected = room._id === currentRoomId;
                dropdown.appendChild(option);
            });
        }

        // Override the original updateRoomsList to also update mobile dropdown
        const originalUpdateRoomsList = window.updateRoomsList;
        window.updateRoomsList = function() {
            if (originalUpdateRoomsList) {
                originalUpdateRoomsList();
            }
            updateMobileRoomDropdown();
        };

        // Override room switching to enable input when room is selected
        const originalSwitchRoom = window.switchRoom;
        window.switchRoom = async function(roomId) {
            if (!roomId) return;
            
            const result = await originalSwitchRoom(roomId);
            
            // Enable message input and buttons
            const messageInput = document.getElementById('communityMessageInput');
            const sendButton = document.getElementById('sendCommunityButton');
            const emojiButton = document.getElementById('emojiBtn');
            
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = 'Type your message...';
            }
            if (sendButton) sendButton.disabled = false;
            if (emojiButton) emojiButton.disabled = false;
            
            // Update mobile dropdown
            updateMobileRoomDropdown();
            
            return result;
        };

        // Enhanced navigation functions
        function goToNotifications() {
            window.location.href = 'notifications.html';
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Initialize layout on load and resize
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileLayout();
            
            // Wait for community.js to load
            setTimeout(() => {
                if (window.initializeCommunity) {
                    initializeCommunity();
                }
            }, 100);
        });

        window.addEventListener('resize', initializeMobileLayout);
        window.addEventListener('orientationchange', () => {
            setTimeout(initializeMobileLayout, 100);
        });

        // Add notification count functionality
        async function updateNotificationCount() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
                if (!token) return;
                
                const response = await fetch('https://ai-coach-backend-pbse.onrender.com/api/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.count || 0;
                    const countElement = document.getElementById('headerNotificationCount');
                    
                    if (countElement) {
                        countElement.textContent = count;
                        countElement.setAttribute('data-count', count);
                        countElement.style.display = count > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error fetching notification count:', error);
            }
        }

        // Update notification count periodically
        updateNotificationCount();
        setInterval(updateNotificationCount, 30000);
    </script>

    <style>
        /* Community Responsive Layout Styles */
        .community-responsive-container {
            display: flex;
            height: calc(100vh - 8rem);
            background: var(--background);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-right: 2rem;
        }

        .mobile-room-selector {
            width: 100%;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* Desktop-only visibility */
        @media (max-width: 1024px) {
            .desktop-only {
                display: none !important;
            }
            
            .community-responsive-container {
                flex-direction: column;
                height: calc(100vh - 6rem);
                margin-right: 0;
            }
            
            .mobile-room-selector {
                flex-shrink: 0;
                border-bottom: 2px solid var(--border);
                background: var(--background);
            }
            
            .chat-area {
                flex: 1;
                min-height: 0;
            }
            
            .chat-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .room-title h2 {
                font-size: 1.25rem;
                margin: 0;
            }
            
            .room-title p {
                font-size: 0.875rem;
                margin: 0.25rem 0 0 0;
                opacity: 0.8;
            }
            
            .chat-messages {
                padding: 1rem;
                font-size: 0.95rem;
            }
            
            .chat-input-area {
                padding: 1rem;
                border-top: 2px solid var(--border);
            }
            
            .chat-input {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .input-actions {
                justify-content: space-between;
                gap: 0.75rem;
            }
            
            .input-actions .btn {
                flex: 1;
                min-height: 44px;
                font-size: 0.95rem;
            }
            
            /* Make sure message input is properly sized */
            #communityMessageInput {
                min-height: 44px !important;
                font-size: 16px !important;
                line-height: 1.4;
                padding: 0.75rem !important;
            }
            
            /* Mobile message styling */
            .message-group {
                margin-bottom: 1rem;
            }
            
            .message-header {
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
            
            .username {
                font-size: 0.9rem;
                font-weight: 600;
            }
            
            .message-timestamp {
                font-size: 0.8rem;
                margin-left: auto;
            }
            
            .message-content {
                margin-left: 2rem;
                padding: 0.75rem;
                font-size: 0.95rem;
                line-height: 1.4;
                border-radius: var(--radius);
                background: var(--surface);
                border: 1px solid var(--border);
            }
        }

        /* Animation for spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced mobile touch targets */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 0.95rem;
            }
            
            select {
                min-height: 44px;
                font-size: 16px;
            }
            
            textarea {
                min-height: 44px;
                font-size: 16px;
            }
        }

        /* Ensure proper scroll behavior */
        .chat-messages-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1.5rem;
        }

        /* Hide scrollbars on mobile for cleaner look */
        @media (max-width: 1024px) {
            .chat-messages::-webkit-scrollbar {
                display: none;
            }
            
            .chat-messages {
                scrollbar-width: none;
            }
        }
    </style>
</body>
</html>
