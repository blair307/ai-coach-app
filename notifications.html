// Updated notifications.js - Replace localStorage with database API calls

// Global variables
let currentNotifications = [];
let currentFilter = 'all';

// Load notifications from database on page load
async function loadNotifications() {
    try {
        showLoading();
        currentNotifications = await window.notificationsAPI.getAll();
        renderNotifications();
        updateFilterCounts();
    } catch (error) {
        console.error('Error loading notifications:', error);
        window.handleAPIError(error);
        // Fallback to empty state
        currentNotifications = [];
        renderNotifications();
    } finally {
        hideLoading();
    }
}

// Filter notifications by type
function filterNotifications(type) {
    currentFilter = type;
    
    // Update active filter button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderNotifications();
}

// Render notifications based on current filter
function renderNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    const emptyState = document.getElementById('emptyState');
    
    // Filter notifications based on current filter
    let filteredNotifications = currentNotifications;
    
    if (currentFilter !== 'all') {
        if (currentFilter === 'unread') {
            filteredNotifications = currentNotifications.filter(n => !n.read);
        } else {
            filteredNotifications = currentNotifications.filter(n => n.type === currentFilter);
        }
    }
    
    if (filteredNotifications.length === 0) {
        notificationsList.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    notificationsList.style.display = 'block';
    emptyState.style.display = 'none';
    
    notificationsList.innerHTML = filteredNotifications.map(notification => `
        <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-type="${notification.type}" data-id="${notification._id}">
            <div class="notification-icon ${notification.type}">
                <div class="icon-text">${getNotificationIcon(notification.type)}</div>
            </div>
            <div class="notification-content">
                <div class="notification-header">
                    <h3>${notification.title}</h3>
                    <span class="notification-time">${formatTime(notification.createdAt)}</span>
                </div>
                <p>${notification.content}</p>
                <div class="notification-actions">
                    ${getNotificationActions(notification)}
                    ${!notification.read ? `<button class="btn-link" onclick="markAsRead('${notification._id}')">Mark as Read</button>` : ''}
                    <button class="btn-link" onclick="deleteNotification('${notification._id}')">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

// Get icon text for notification type
function getNotificationIcon(type) {
    const icons = {
        coaching: 'AI',
        community: 'CM',
        system: 'SY',
        billing: 'BI'
    };
    return icons[type] || 'NO';
}

// Get actions based on notification type
function getNotificationActions(notification) {
    const actions = {
        coaching: '<button class="btn-link" onclick="goToCoach()">View Insights</button>',
        community: '<button class="btn-link" onclick="goToCommunity()">Join Conversation</button>',
        system: '<button class="btn-link" onclick="goToDashboard()">View Report</button>',
        billing: '<button class="btn-link" onclick="goToBilling()">View Receipt</button>'
    };
    return actions[notification.type] || '';
}

// Format time for display
function formatTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);
    
    if (diffInHours < 1) {
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));
        return `${diffInMinutes} minute${diffInMinutes !== 1 ? 's' : ''} ago`;
    } else if (diffInHours < 24) {
        const hours = Math.floor(diffInHours);
        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
    } else {
        const days = Math.floor(diffInHours / 24);
        return `${days} day${days !== 1 ? 's' : ''} ago`;
    }
}

// Mark notification as read
async function markAsRead(notificationId) {
    try {
        await window.notificationsAPI.markAsRead(notificationId);
        
        // Update local array
        const notification = currentNotifications.find(n => n._id === notificationId);
        if (notification) {
            notification.read = true;
        }
        
        renderNotifications();
        updateFilterCounts();
        showToast('Notification marked as read');
        
    } catch (error) {
        console.error('Error marking notification as read:', error);
        window.handleAPIError(error);
    }
}

// Delete notification
async function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification?')) {
        return;
    }
    
    try {
        await window.notificationsAPI.delete(notificationId);
        
        // Remove from local array
        currentNotifications = currentNotifications.filter(n => n._id !== notificationId);
        
        renderNotifications();
        updateFilterCounts();
        showToast('Notification deleted');
        
    } catch (error) {
        console.error('Error deleting notification:', error);
        window.handleAPIError(error);
    }
}

// Mark all notifications as read
async function markAllRead() {
    const unreadNotifications = currentNotifications.filter(n => !n.read);
    
    if (unreadNotifications.length === 0) {
        showToast('No unread notifications');
        return;
    }
    
    try {
        showButtonLoading('Marking all read...');
        
        // Mark all unread notifications as read
        await Promise.all(
            unreadNotifications.map(notification => 
                window.notificationsAPI.markAsRead(notification._id)
            )
        );
        
        // Update local array
        currentNotifications.forEach(notification => {
            notification.read = true;
        });
        
        renderNotifications();
        updateFilterCounts();
        showToast('All notifications marked as read');
        
    } catch (error) {
        console.error('Error marking all as read:', error);
        window.handleAPIError(error);
    } finally {
        hideButtonLoading();
    }
}

// Clear all notifications
async function clearAll() {
    if (!confirm('Are you sure you want to delete ALL notifications? This cannot be undone.')) {
        return;
    }
    
    try {
        showButtonLoading('Clearing all...');
        
        // Delete all notifications
        await Promise.all(
            currentNotifications.map(notification => 
                window.notificationsAPI.delete(notification._id)
            )
        );
        
        currentNotifications = [];
        renderNotifications();
        updateFilterCounts();
        showToast('All notifications cleared');
        
    } catch (error) {
        console.error('Error clearing all notifications:', error);
        window.handleAPIError(error);
    } finally {
        hideButtonLoading();
    }
}

// Update filter counts
function updateFilterCounts() {
    const counts = {
        all: currentNotifications.length,
        unread: currentNotifications.filter(n => !n.read).length,
        coaching: currentNotifications.filter(n => n.type === 'coaching').length,
        community: currentNotifications.filter(n => n.type === 'community').length,
        system: currentNotifications.filter(n => n.type === 'system').length,
        billing: currentNotifications.filter(n => n.type === 'billing').length
    };
    
    Object.keys(counts).forEach(type => {
        const countElement = document.getElementById(`${type}Count`);
        if (countElement) {
            countElement.textContent = counts[type];
        }
    });
    
    // Update notification badge in sidebar
    const badge = document.getElementById('notificationBadge');
    if (badge) {
        badge.textContent = counts.unread;
        badge.style.display = counts.unread > 0 ? 'inline' : 'none';
    }
}

// Navigation functions
function goToCoach() {
    window.location.href = 'ai-coach.html';
}

function goToCommunity() {
    window.location.href = 'community.html';
}

function goToDashboard() {
    window.location.href = 'dashboard.html';
}

function goToBilling() {
    window.location.href = 'billing.html';
}

// Utility functions
function showLoading() {
    const notificationsList = document.getElementById('notificationsList');
    notificationsList.innerHTML = '<div class="loading-spinner">Loading notifications...</div>';
}

function hideLoading() {
    // Loading state is cleared by renderNotifications()
}

function showButtonLoading(text) {
    const markAllBtn = document.getElementById('markAllReadBtn');
    if (markAllBtn) {
        markAllBtn.textContent = text;
        markAllBtn.disabled = true;
    }
}

function hideButtonLoading() {
    const markAllBtn = document.getElementById('markAllReadBtn');
    if (markAllBtn) {
        markAllBtn.textContent = 'Mark All Read';
        markAllBtn.disabled = false;
    }
}

function showToast(message) {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('eeh_token');
    localStorage.removeItem('userData');
    window.location.href = 'login.html';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const token = localStorage.getItem('authToken') || localStorage.getItem('eeh_token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // Load notifications from database
    loadNotifications();
    
    console.log('Notifications page initialized with database');
});

// Export functions for global access
window.filterNotifications = filterNotifications;
window.markAsRead = markAsRead;
window.deleteNotification = deleteNotification;
window.markAllRead = markAllRead;
window.clearAll = clearAll;
window.goToCoach = goToCoach;
window.goToCommunity = goToCommunity;
window.goToDashboard = goToDashboard;
window.goToBilling = goToBilling;
window.logout = logout;
