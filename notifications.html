<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- ADD THIS: Notification Manager -->
    <script src="notification-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.notificationManager) {
                window.notificationManager.init();
                setTimeout(() => {
                    window.notificationManager.updateBadge();
                    loadNotifications(); // Load notifications immediately
                }, 100);
            }
        });
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
                <button class="sidebar-toggle" aria-label="Toggle navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="menu-item">
                    Dashboard
                </a></li>
                <li><a href="ai-coach.html" class="menu-item">
                    AI Coach
                </a></li>
                <li><a href="community.html" class="menu-item">
                    Community
                </a></li>
                <li><a href="notifications.html" class="menu-item active">
                    Notifications
                    <span class="notification-badge" id="notificationBadge">0</span>
                </a></li>
                <li><a href="billing.html" class="menu-item">
                    Billing
                </a></li>
                <li><a href="#" class="menu-item" onclick="logout()">
                    Logout
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Notifications</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="markAllRead()" id="markAllReadBtn">
                        Mark All Read
                    </button>
                    <button class="btn btn-outline" onclick="clearAll()">
                        Clear All
                    </button>
                </div>
            </header>

            <div class="notifications-container">
                <!-- Notification Filters -->
                <div class="notification-filters" id="notificationFilters">
                    <button class="filter-btn active" onclick="filterNotifications('all')">
                        All Notifications
                        <span class="count" id="allCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('unread')">
                        Unread
                        <span class="count" id="unreadCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('coaching')">
                        AI Coach
                        <span class="count" id="coachingCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('community')">
                        Community
                        <span class="count" id="communityCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('system')">
                        System
                        <span class="count" id="systemCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('billing')">
                        Billing
                        <span class="count" id="billingCount">0</span>
                    </button>
                </div>

                <!-- Notifications List -->
                <div class="notifications-list" id="notificationsList">
                    <!-- Notifications will be populated by JavaScript from notification manager -->
                </div>

                <!-- Empty State (Hidden by default) -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>No notifications found</h3>
                    <p>You're all caught up! Check back later for updates on your emotional health journey.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal" id="settingsModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Notification Settings</h3>
                <button class="close-btn" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>
                        <input type="checkbox" checked> AI Coach Insights
                    </label>
                    <small>Get notified when new coaching insights are available</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" checked> Community Messages
                    </label>
                    <small>Receive notifications for community activity</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" checked> Weekly Reports
                    </label>
                    <small>Get your weekly progress summaries</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" checked> Billing Updates
                    </label>
                    <small>Payment confirmations and billing reminders</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script src="sidebar-toggle.js"></script>
    <script src="notifications.js"></script>
    
    <script>
    // Global variables
    let currentFilter = 'all';

    // Common logout function
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('eeh_token');
        localStorage.removeItem('userData');
        localStorage.removeItem('eeh_notifications');
        localStorage.removeItem('eeh_rooms');
        window.location.href = 'login.html';
    }

    // FIXED: Notification management functions that work with notification manager
    function markAllRead() {
        if (window.notificationManager) {
            window.notificationManager.markAllAsRead();
            // Refresh will happen automatically via event listener
        }
    }

    function clearAll() {
        if (confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
            if (window.notificationManager) {
                window.notificationManager.clearAllNotifications();
                // Refresh will happen automatically via event listener
            }
        }
    }

    function markAsRead(element) {
        const notificationItem = element.closest('.notification-item');
        const notificationId = parseInt(notificationItem.getAttribute('data-id'));
        
        if (window.notificationManager) {
            window.notificationManager.markAsRead(notificationId);
            // Refresh will happen automatically via event listener
        }
    }

    function goToCoach() {
        window.location.href = 'ai-coach.html';
    }

    function goToCommunity() {
        window.location.href = 'community.html';
    }

    function goToDashboard() {
        window.location.href = 'dashboard.html';
    }

    function goToBilling() {
        window.location.href = 'billing.html';
    }

    function filterNotifications(type) {
        currentFilter = type;
        
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Filter notifications
        const notifications = document.querySelectorAll('.notification-item');
        let visibleCount = 0;
        
        notifications.forEach(notification => {
            const notificationType = notification.getAttribute('data-type');
            const isUnread = notification.classList.contains('unread');
            
            let shouldShow = false;
            if (type === 'all') {
                shouldShow = true;
            } else if (type === 'unread') {
                shouldShow = isUnread;
            } else {
                shouldShow = (type === notificationType);
            }
            
            if (shouldShow) {
                notification.style.display = 'flex';
                visibleCount++;
            } else {
                notification.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        const emptyState = document.getElementById('emptyState');
        const notificationsList = document.getElementById('notificationsList');
        if (visibleCount === 0) {
            emptyState.style.display = 'block';
            notificationsList.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            notificationsList.style.display = 'block';
        }
    }

    function closeSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function saveSettings() {
        alert('Settings saved successfully!');
        closeSettingsModal();
    }

    // FIXED: Load notifications from notification manager
    function loadNotifications() {
        if (!window.notificationManager) {
            console.log('Notification manager not ready yet');
            return;
        }
        
        const notifications = window.notificationManager.getNotifications();
        const notificationsList = document.getElementById('notificationsList');
        
        console.log('Loading', notifications.length, 'notifications');
        
        if (notifications.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            notificationsList.style.display = 'none';
            updateFilterCounts();
            return;
        }
        
        // Sort notifications by timestamp (newest first)
        const sortedNotifications = notifications.sort((a, b) => b.timestamp - a.timestamp);
        
        notificationsList.innerHTML = sortedNotifications.map(notification => `
            <div class="notification-item ${notification.unread ? 'unread' : 'read'}" data-type="${notification.type}" data-id="${notification.id}">
                <div class="notification-icon ${notification.type}">
                    <div class="icon-text">${getIconText(notification.type)}</div>
                </div>
                <div class="notification-content">
                    <div class="notification-header">
                        <h3>${notification.title}</h3>
                        <span class="notification-time">${notification.time}</span>
                    </div>
                    <p>${notification.message}</p>
                    <div class="notification-actions">
                        ${getActionButtons(notification)}
                        ${notification.unread ? '<button class="btn-link" onclick="markAsRead(this)">Mark as Read</button>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        // Update filter counts
        updateFilterCounts();
        
        // Apply current filter
        if (currentFilter !== 'all') {
            // Re-trigger the current filter
            const activeButton = document.querySelector('.filter-btn.active');
            if (activeButton) {
                filterNotifications(currentFilter);
            }
        }
        
        // Show notifications list
        notificationsList.style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        
        console.log('Loaded notifications successfully');
    }

    function getIconText(type) {
        const icons = {
            'coaching': 'AI',
            'community': 'CM',
            'system': 'SY',
            'billing': 'BI'
        };
        return icons[type] || 'NO';
    }

    function getActionButtons(notification) {
        const actions = {
            'coaching': '<button class="btn-link" onclick="goToCoach()">View Insights</button>',
            'community': '<button class="btn-link" onclick="goToCommunity()">Join Conversation</button>',
            'system': '<button class="btn-link" onclick="goToDashboard()">View Report</button>',
            'billing': '<button class="btn-link" onclick="goToBilling()">View Receipt</button>'
        };
        return actions[notification.type] || '';
    }

    function updateFilterCounts() {
        if (!window.notificationManager) return;
        
        const notifications = window.notificationManager.getNotifications();
        const counts = {
            all: notifications.length,
            unread: notifications.filter(n => n.unread).length,
            coaching: notifications.filter(n => n.type === 'coaching').length,
            community: notifications.filter(n => n.type === 'community').length,
            system: notifications.filter(n => n.type === 'system').length,
            billing: notifications.filter(n => n.type === 'billing').length
        };
        
        console.log('Filter counts:', counts);
        
        Object.keys(counts).forEach(type => {
            const countElement = document.getElementById(`${type}Count`);
            if (countElement) {
                countElement.textContent = counts[type];
            }
        });
    }

    // Listen for notification updates from the manager
    window.addEventListener('notificationsUpdated', function() {
        console.log('Notifications updated event received');
        loadNotifications();
    });

    // Initialize notifications when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit longer for notification manager to fully initialize
        setTimeout(() => {
            if (window.notificationManager && window.notificationManager.initialized) {
                loadNotifications();
            } else {
                // Try again after another delay
                setTimeout(() => {
                    loadNotifications();
                }, 500);
            }
        }, 200);
    });

    // Debug function - you can call this in console to check status
    function debugNotifications() {
        console.log('Notification Manager:', window.notificationManager);
        console.log('Initialized:', window.notificationManager?.initialized);
        console.log('Notifications:', window.notificationManager?.getNotifications());
        console.log('Unread count:', window.notificationManager?.getUnreadCount());
    }
    
    // Add to window for debugging
    window.debugNotifications = debugNotifications;
    </script>

    <style>
    /* Add notification icon styling */
    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .notification-icon.coaching {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
    }
    
    .notification-icon.community {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
    }
    
    .notification-icon.system {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        color: white;
    }
    
    .notification-icon.billing {
        background: linear-gradient(135deg, var(--accent) 0%, #0284c7 100%);
        color: white;
    }
    
    .notification-item {
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .notification-content {
        flex: 1;
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .notification-header h3 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 600;
    }
    
    .notification-time {
        color: var(--text-muted);
        font-size: 0.875rem;
        flex-shrink: 0;
        margin-left: 1rem;
    }
    
    .notification-content p {
        color: var(--text-secondary);
        margin: 0 0 1rem 0;
        line-height: 1.5;
    }
    
    .notification-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    </style>
</body>
</html>
