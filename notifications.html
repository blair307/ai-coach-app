<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Entrepreneur Emotional Health</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>EEH</h2>
                <button class="sidebar-toggle" aria-label="Toggle navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
         <ul class="sidebar-menu">
    <li><a href="dashboard.html" class="menu-item">
        Dashboard
    </a></li>
    <li><a href="ai-coach.html" class="menu-item">
        AI Coach
    </a></li>
    <li><a href="community.html" class="menu-item">
        Community
    </a></li>
    <li><a href="notifications.html" class="menu-item active">
        Notifications
        <span class="notification-badge" id="notificationBadge">3</span>
    </a></li>
    <li><a href="billing.html" class="menu-item">
        Billing
    </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Notifications</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="markAllRead()" id="markAllReadBtn">
                        Mark All Read
                    </button>
                    <button class="btn btn-outline" onclick="clearAll()">
                        Clear All
                    </button>
                </div>
            </header>

            <div class="notifications-container">
                <!-- Notification Filters -->
                <div class="notification-filters" id="notificationFilters">
                    <button class="filter-btn active" onclick="filterNotifications('all')">
                        All Notifications
                        <span class="count" id="allCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('unread')">
                        Unread
                        <span class="count" id="unreadCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('coaching')">
                        AI Coach
                        <span class="count" id="coachingCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('community')">
                        Community
                        <span class="count" id="communityCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('system')">
                        System
                        <span class="count" id="systemCount">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterNotifications('billing')">
                        Billing
                        <span class="count" id="billingCount">0</span>
                    </button>
                </div>

                <!-- Notifications List -->
                <div class="notifications-list" id="notificationsList">
                    <!-- Notifications will be populated by JavaScript -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>No notifications found</h3>
                    <p>You're all caught up! Check back later for updates on your emotional health journey.</p>
                </div>
            </div>
        </main>
    </div>

    <script src="api-service.js"></script>
    <script src="sidebar-toggle.js"></script>
    <script src="notifications.js"></script>
    
    <script>
    // ===== NOTIFICATION MANAGER - INLINE =====
    class NotificationManager {
        constructor() {
            this.unreadCount = 0;
            this.notifications = [];
            this.initialized = false;
        }

        init() {
            if (this.initialized) return;
            this.loadNotifications();
            this.updateBadge();
            this.initialized = true;
            console.log('Notification Manager initialized with', this.unreadCount, 'unread notifications');
        }

        loadNotifications() {
            const saved = localStorage.getItem('eeh_notifications');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    this.notifications = data.notifications || [];
                    this.unreadCount = this.notifications.filter(n => n.unread).length;
                    console.log('Loaded', this.notifications.length, 'notifications,', this.unreadCount, 'unread');
                    return;
                } catch (e) {
                    console.log('Error loading saved notifications:', e);
                }
            }

            // Default notifications
            this.notifications = [
                {
                    id: 1, type: 'coaching', title: 'New Coaching Insights Available',
                    message: 'Your AI coach has generated new insights based on your recent conversations. Review your personalized recommendations for emotional wellness and business growth.',
                    time: '2 hours ago', unread: true, timestamp: Date.now() - (2 * 60 * 60 * 1000)
                },
                {
                    id: 2, type: 'community', title: 'New Messages in Business Growth',
                    message: 'Sarah Johnson and 3 others have shared new insights in the Business Growth room. Join the conversation about scaling strategies.',
                    time: '4 hours ago', unread: true, timestamp: Date.now() - (4 * 60 * 60 * 1000)
                },
                {
                    id: 3, type: 'system', title: 'Weekly Progress Report Ready',
                    message: 'Your weekly emotional health and business progress report is now available. See your growth patterns and achievements.',
                    time: '1 day ago', unread: true, timestamp: Date.now() - (24 * 60 * 60 * 1000)
                },
                {
                    id: 4, type: 'coaching', title: 'Goal Achievement Milestone',
                    message: 'Congratulations! You\'ve completed 75% of your quarterly emotional wellness goals. Your AI coach has updated your action plan.',
                    time: '2 days ago', unread: false, timestamp: Date.now() - (2 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 5, type: 'community', title: 'Someone Mentioned You',
                    message: 'Mike Chen mentioned you in the Success Stories room. Check out the discussion about overcoming entrepreneurial challenges.',
                    time: '3 days ago', unread: false, timestamp: Date.now() - (3 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 6, type: 'community', title: 'New Room Created: Mindfulness',
                    message: 'A new community room "Mindfulness & Meditation" has been created. Join entrepreneurs discussing stress management techniques.',
                    time: '4 days ago', unread: false, timestamp: Date.now() - (4 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 7, type: 'system', title: 'Platform Update: New Features',
                    message: 'We\'ve added new emotional intelligence tracking features and enhanced AI coaching capabilities. Explore the improvements in your dashboard.',
                    time: '1 week ago', unread: false, timestamp: Date.now() - (7 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 8, type: 'billing', title: 'Payment Successful',
                    message: 'Your yearly subscription payment of $929 has been processed successfully. Thank you for continuing your emotional health journey with us.',
                    time: '1 week ago', unread: false, timestamp: Date.now() - (7 * 24 * 60 * 60 * 1000)
                }
            ];

            this.unreadCount = this.notifications.filter(n => n.unread).length;
            this.saveNotifications();
            console.log('Created default notifications:', this.notifications.length, 'total,', this.unreadCount, 'unread');
        }

        saveNotifications() {
            this.unreadCount = this.notifications.filter(n => n.unread).length;
            const data = {
                notifications: this.notifications,
                unreadCount: this.unreadCount,
                lastUpdated: Date.now()
            };
            localStorage.setItem('eeh_notifications', JSON.stringify(data));
            console.log('Saved notifications:', this.notifications.length, 'total,', this.unreadCount, 'unread');
        }

        updateBadge() {
            this.unreadCount = this.notifications.filter(n => n.unread).length;
            const badges = document.querySelectorAll('#notificationBadge, .notification-badge');
            badges.forEach(badge => {
                if (this.unreadCount > 0) {
                    badge.textContent = this.unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            });
            console.log('Updated badges to show:', this.unreadCount);
        }

        addNotification(notification) {
            const newNotification = {
                id: Date.now(),
                unread: true,
                timestamp: Date.now(),
                ...notification
            };
            this.notifications.unshift(newNotification);
            this.saveNotifications();
            this.updateBadge();
            console.log('New notification added:', newNotification.title, '| Total unread:', this.unreadCount);
        }

        markAsRead(notificationId) {
            const notification = this.notifications.find(n => n.id === notificationId);
            if (notification && notification.unread) {
                notification.unread = false;
                this.saveNotifications();
                this.updateBadge();
                console.log('Marked notification', notificationId, 'as read | Remaining unread:', this.unreadCount);
            }
        }

        markAllAsRead() {
            let changed = false;
            this.notifications.forEach(n => {
                if (n.unread) {
                    n.unread = false;
                    changed = true;
                }
            });
            
            if (changed) {
                this.saveNotifications();
                this.updateBadge();
                console.log('Marked all notifications as read');
            }
        }

        clearAllNotifications() {
            this.notifications = [];
            this.saveNotifications();
            this.updateBadge();
            console.log('Cleared all notifications');
        }

        getUnreadCount() {
            this.unreadCount = this.notifications.filter(n => n.unread).length;
            return this.unreadCount;
        }

        getNotifications() {
            return this.notifications;
        }
    }

    // ===== INITIALIZE MANAGER =====
    window.notificationManager = new NotificationManager();

    // ===== MAIN FUNCTIONALITY =====
    let currentFilter = 'all';

    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('eeh_token');
        localStorage.removeItem('userData');
        localStorage.removeItem('eeh_notifications');
        localStorage.removeItem('eeh_rooms');
        window.location.href = 'login.html';
    }

    function markAllRead() {
        console.log('Mark all read clicked');
        if (window.notificationManager) {
            window.notificationManager.markAllAsRead();
            loadNotifications(); // Refresh immediately
            console.log('All notifications marked as read');
        }
    }

    function clearAll() {
        console.log('Clear all clicked');
        if (confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
            if (window.notificationManager) {
                window.notificationManager.clearAllNotifications();
                loadNotifications(); // Refresh immediately
                console.log('All notifications cleared');
            }
        }
    }

    function markAsRead(element) {
        const notificationItem = element.closest('.notification-item');
        const notificationId = parseInt(notificationItem.getAttribute('data-id'));
        
        console.log('Mark as read clicked for notification:', notificationId);
        
        if (window.notificationManager) {
            window.notificationManager.markAsRead(notificationId);
            notificationItem.classList.remove('unread');
            notificationItem.classList.add('read');
            element.remove(); // Remove the "Mark as Read" button
            updateFilterCounts();
            console.log('Notification', notificationId, 'marked as read');
        }
    }

    function goToCoach() { window.location.href = 'ai-coach.html'; }
    function goToCommunity() { window.location.href = 'community.html'; }
    function goToDashboard() { window.location.href = 'dashboard.html'; }
    function goToBilling() { window.location.href = 'billing.html'; }

    function filterNotifications(type) {
        currentFilter = type;
        
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const notifications = document.querySelectorAll('.notification-item');
        let visibleCount = 0;
        
        notifications.forEach(notification => {
            const notificationType = notification.getAttribute('data-type');
            const isUnread = notification.classList.contains('unread');
            
            let shouldShow = false;
            if (type === 'all') {
                shouldShow = true;
            } else if (type === 'unread') {
                shouldShow = isUnread;
            } else {
                shouldShow = (type === notificationType);
            }
            
            if (shouldShow) {
                notification.style.display = 'flex';
                visibleCount++;
            } else {
                notification.style.display = 'none';
            }
        });
        
        const emptyState = document.getElementById('emptyState');
        const notificationsList = document.getElementById('notificationsList');
        if (visibleCount === 0) {
            emptyState.style.display = 'block';
            notificationsList.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            notificationsList.style.display = 'block';
        }
    }

    function loadNotifications() {
        console.log('Loading notifications...');
        
        if (!window.notificationManager) {
            console.log('Notification manager not ready yet');
            return;
        }
        
        const notifications = window.notificationManager.getNotifications();
        const notificationsList = document.getElementById('notificationsList');
        
        console.log('Found', notifications.length, 'notifications');
        
        if (notifications.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            notificationsList.style.display = 'none';
            updateFilterCounts();
            return;
        }
        
        const sortedNotifications = notifications.sort((a, b) => b.timestamp - a.timestamp);
        
        notificationsList.innerHTML = sortedNotifications.map(notification => `
            <div class="notification-item ${notification.unread ? 'unread' : 'read'}" data-type="${notification.type}" data-id="${notification.id}">
                <div class="notification-icon ${notification.type}">
                    <div class="icon-text">${getIconText(notification.type)}</div>
                </div>
                <div class="notification-content">
                    <div class="notification-header">
                        <h3>${notification.title}</h3>
                        <span class="notification-time">${notification.time}</span>
                    </div>
                    <p>${notification.message}</p>
                    <div class="notification-actions">
                        ${getActionButtons(notification)}
                        ${notification.unread ? '<button class="btn-link" onclick="markAsRead(this)">Mark as Read</button>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        updateFilterCounts();
        
        if (currentFilter !== 'all') {
            const activeButton = document.querySelector('.filter-btn.active');
            if (activeButton) {
                filterNotifications(currentFilter);
            }
        }
        
        notificationsList.style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        
        console.log('Notifications loaded successfully');
    }

    function getIconText(type) {
        const icons = {
            'coaching': 'AI',
            'community': 'CM',
            'system': 'SY',
            'billing': 'BI'
        };
        return icons[type] || 'NO';
    }

    function getActionButtons(notification) {
        const actions = {
            'coaching': '<button class="btn-link" onclick="goToCoach()">View Insights</button>',
            'community': '<button class="btn-link" onclick="goToCommunity()">Join Conversation</button>',
            'system': '<button class="btn-link" onclick="goToDashboard()">View Report</button>',
            'billing': '<button class="btn-link" onclick="goToBilling()">View Receipt</button>'
        };
        return actions[notification.type] || '';
    }

    function updateFilterCounts() {
        if (!window.notificationManager) return;
        
        const notifications = window.notificationManager.getNotifications();
        const counts = {
            all: notifications.length,
            unread: notifications.filter(n => n.unread).length,
            coaching: notifications.filter(n => n.type === 'coaching').length,
            community: notifications.filter(n => n.type === 'community').length,
            system: notifications.filter(n => n.type === 'system').length,
            billing: notifications.filter(n => n.type === 'billing').length
        };
        
        console.log('Filter counts:', counts);
        
        Object.keys(counts).forEach(type => {
            const countElement = document.getElementById(`${type}Count`);
            if (countElement) {
                countElement.textContent = counts[type];
            }
        });
    }

    // INITIALIZE
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing notifications');
        
        window.notificationManager.init();
        
        setTimeout(() => {
            window.notificationManager.updateBadge();
            loadNotifications();
        }, 200);
    });

    // Debug function
    function debugNotifications() {
        console.log('=== NOTIFICATION DEBUG ===');
        console.log('Notification Manager:', window.notificationManager);
        console.log('Initialized:', window.notificationManager?.initialized);
        console.log('Notifications count:', window.notificationManager?.getNotifications()?.length);
        console.log('Unread count:', window.notificationManager?.getUnreadCount());
        console.log('All notifications:', window.notificationManager?.getNotifications());
        console.log('========================');
    }
    
    window.debugNotifications = debugNotifications;
    </script>

    <style>
    /* Notification icon styling */
    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .notification-icon.coaching {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
    }
    
    .notification-icon.community {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
    }
    
    .notification-icon.system {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        color: white;
    }
    
    .notification-icon.billing {
        background: linear-gradient(135deg, var(--accent) 0%, #0284c7 100%);
        color: white;
    }
    
    .notification-item {
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .notification-item:hover {
        background: var(--surface);
    }
    
    .notification-content {
        flex: 1;
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .notification-header h3 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 600;
    }
    
    .notification-time {
        color: var(--text-muted);
        font-size: 0.875rem;
        flex-shrink: 0;
        margin-left: 1rem;
    }
    
    .notification-content p {
        color: var(--text-secondary);
        margin: 0 0 1rem 0;
        line-height: 1.5;
    }
    
    .notification-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-link {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 0.875rem;
        padding: 0;
        text-decoration: underline;
        transition: color 0.2s;
        font-weight: 500;
    }
    
    .btn-link:hover {
        color: var(--primary-dark);
    }
    
    .notification-item.unread {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(14, 165, 233, 0.02) 100%);
        border-left: 4px solid var(--primary);
    }
    
    .notification-item.read {
        opacity: 0.8;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-muted);
    }
    
    .empty-state h3 {
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .empty-state p {
        margin: 0;
    }
    </style>

</body>
</html>
